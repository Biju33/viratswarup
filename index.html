<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIRAT SWARUP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Global Resets and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px; /* Base font size */
        }

        body {
            background: #f4f6f8; /* Light cool gray background */
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* Modern sans-serif stack */
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom nav, increased */
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }

        /* Headings and Thematic Font */
        h1, h2, h3, h4, h5, h6 {
            font-family: "Georgia", serif; /* Keep Georgia for headings */
            color: #2c2c2c;
            line-height: 1.3;
        }

        a {
            color: #8b0000;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        a:hover {
            color: #6a0000;
        }

        /* Buttons General Styling */
        button, .button-like { /* .button-like for a tags styled as buttons */
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease;
            border: none;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:active, .button-like:active {
            transform: translateY(1px);
        }
        button:disabled, .button-like:disabled {
            background: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: #8b0000;
            color: white;
        }
        .btn-primary:hover {
            background-color: #6a0000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        
        /* Input Fields General Styling */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.5;
            font-family: inherit;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 15px;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            border-color: #8b0000;
            box-shadow: 0 0 0 0.2rem rgba(139,0,0,0.25);
            outline: none;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }


        /* Header */
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px clamp(15px, 4vw, 60px); /* Responsive padding */
            border-bottom: 1px solid #d9a7a7; /* Softer border */
            background-color: #8b0000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .header-logo {
            position: absolute;
            left: clamp(15px, 4vw, 30px);
            top: 50%;
            transform: translateY(-50%);
            height: 70px; /* Adjusted */
            width: 70px;  /* Adjusted */
            object-fit: contain;
        }

        .header-text-content {
            text-align: center;
            margin-left: 90px; /* Space for logo on left */
            margin-right: 90px; /* Space for potential menu icon on right if not fixed */
        }

        .header h1 {
            font-size: clamp(1.8rem, 5vw, 2.6rem); /* Fluid font size */
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 5px;
            color: white;
            font-weight: 700; /* Bolder */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        .header h2 {
            font-size: clamp(1rem, 3vw, 1.3rem); /* Fluid font size */
            color: #f5f5f5;
            font-weight: 300;
            margin-top: 0;
            margin-bottom: 0;
            letter-spacing: 0.5px;
            font-style: italic;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -300px; /* Start off-screen */
            width: 300px;
            max-width: 80%; /* Ensure it doesn't take full screen on small devices */
            height: 100%;
            background: #7a0000; /* Slightly darker maroon for depth */
            box-shadow: -3px 0 15px rgba(0, 0, 0, 0.2);
            transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
            padding-top: 20px; /* Space from top */
            z-index: 1001; /* Above header if header is also fixed/sticky */
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu a, .mobile-menu .language-select-label {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 25px; /* Generous padding for touch */
            color: #fff !important;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            font-size: 1.05rem;
        }
         .mobile-menu .language-select-label { cursor: pointer; }
        .mobile-menu i {
            width: 25px;
            font-size: 1.2rem;
            color: #fff !important;
            text-align: center;
        }
        .mobile-menu a:hover, .mobile-menu .language-select-label:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .mobile-menu a:last-child, .mobile-menu .language-options a:last-child {
            border-bottom: none;
        }
        .language-options {
            padding-left: 0; /* Full width for lang options */
            display: none;
            background-color: rgba(0,0,0,0.2);
        }
        .language-options a {
            padding: 14px 25px 14px 55px; /* Indent text */
            font-size: 0.95em;
        }
        .language-options a.lang-active {
            font-weight: bold;
            background-color: rgba(255,255,255,0.15);
        }


        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #8b0000;
            border-top: 1px solid #7a0000;
            padding: 5px 0; /* Reduced top/bottom padding for compactness */
            display: none; /* Shown via media query */
            z-index: 999;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.15);
        }
        .bottom-nav ul {
            display: flex;
            justify-content: space-around;
            list-style: none;
        }
        .bottom-nav a {
            color: #fff !important;
            font-size: 0.8rem; /* Slightly smaller text */
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 10px;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .bottom-nav a i {
            font-size: 1.3rem; /* Larger icons */
        }
        .bottom-nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .bottom-nav a:active {
            transform: scale(0.95);
        }

        /* Desktop Navigation */
        .desktop-nav {
            margin: 35px 0; /* Reduced margin */
            padding: 0 15px;
        }
        .desktop-nav ul {
            display: flex;
            justify-content: center;
            gap: 15px; /* Reduced gap */
            list-style: none;
            flex-wrap: wrap; /* Allow wrapping on smaller desktop screens */
        }
        .desktop-nav a {
            color: #7a0000; /* Slightly muted maroon */
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            padding: 10px 18px;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
        }
        .desktop-nav a:hover {
            background-color: #f0e0e0; /* Light maroon/pinkish hover */
            color: #5a0000; /* Darker maroon on hover */
        }
        .desktop-nav a i {
           font-size: 1.1em;
        }

        /* Main Container */
        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 25px 15px; /* Responsive padding */
        }

        /* Card Styling (General) */
        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.07);
            padding: 25px;
            margin-bottom: 30px;
        }
        .card-header { /* This class can be added to H3s or divs if needed */
            font-size: 1.5rem;
            color: #8b0000;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }


        /* Login Section */
        .login-section { /* Inherits .card */
            text-align: center;
        }
        .login-section h1 { /* from .card-header if used, or style separately */
            font-size: 1.8rem; color: #8b0000; margin-bottom: 15px;
        }
        .login-section p { margin-bottom: 25px; color: #555; font-size: 1.05rem; }
        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 320px; /* Max width for login buttons */
            margin: 0 auto 15px auto; /* Centering */
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            transition: background-color 0.3s, box-shadow 0.3s;
            border: 1px solid transparent;
            color: white;
        }
        .login-btn i { margin-right: 12px; font-size: 1.25rem; }
        .google-btn { background-color: #db4437; }
        .google-btn:hover { background-color: #c33d2e; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .facebook-btn { background-color: #3b5998; }
        .facebook-btn:hover { background-color: #324d84; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* App Section - User Info */
        .user-info { /* Inherits .card styling */
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info img#userPhoto { /* More specific selector */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #8b0000;
            object-fit: cover;
        }
        .user-info div h2 { margin: 0 0 5px 0; font-size: 1.3rem; color: #333; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; } /* Explicitly use sans-serif */
        #logoutBtn { /* Uses .btn-primary class implicitly through JS or apply here */
            background: #8b0000; color: white; padding: 8px 15px; font-size: 0.9rem;
        }
        #logoutBtn:hover { background: #6a0000; }


        /* Post Form */
        .post-form { /* Inherits .card styling */
        }
        .post-form h3 { /* from .card-header if used, or style here */
           font-size: 1.5rem; color: #8b0000; margin-bottom: 20px;
        }
        /* textarea#postContent uses global textarea styles */

        label[for="postImageFile"] {
            display: inline-flex; /* Changed from inline-block for align-items */
            align-items: center;
            gap: 8px;
            background-color: #e9ecef;
            border: 1px dashed #ced4da; /* Dashed border for upload area */
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            color: #495057;
            transition: background-color 0.3s, border-color 0.3s;
        }
        label[for="postImageFile"]:hover {
            background-color: #dde2e6;
            border-color: #adb5bd;
        }
        label[for="postImageFile"] i { color: #8b0000; }
        #imagePreview {
            max-width: 100%;
            max-height: 250px; /* Increased max height */
            display: none;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            object-fit: cover;
        }
        #uploadProgressContainer { margin-bottom: 15px; }
        #uploadProgressText { font-size: 0.9em; text-align: center; color: #555; }
        #postBtn { /* Uses .btn-primary */
           width: 100%;
           padding: 12px 20px;
        }


        /* Posts Container & Individual Post */
        .posts-container h3 {
            font-size: 1.8rem; /* Adjusted size */
            color: #8b0000;
            border-bottom: 2px solid #e0e0e0; /* Lighter border */
            padding-bottom: 12px;
            margin-bottom: 25px;
        }
        .post { /* Inherits .card styling */
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px; /* Increased margin */
            gap: 12px;
        }
        .post-header img {
            width: 48px; /* Slightly larger */
            height: 48px;
            border-radius: 50%;
            border: 2px solid #f0f0f0; /* Light border, could be user-specific color */
            object-fit: cover;
        }
        .post-header strong { font-size: 1.1rem; color: #2c3e50; font-weight: 600; font-family: inherit; } /* Sans-serif for username */
        .post-header span.timestamp { font-size: 0.85rem; color: #7f8c8d; margin-left: auto; }

        .post-content p {
            font-size: 1rem;
            line-height: 1.7;
            color: #4a4a4a; /* Softer black */
            margin-bottom: 12px;
            white-space: pre-wrap; /* Keep for newlines */
        }
        .post-content img.post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
            display: block;
            border: 1px solid #e9ecef;
        }

        .post-actions {
            display: flex;
            margin-top: 15px;
            gap: 10px; /* Reduced gap */
            border-top: 1px solid #f0f0f0; /* Lighter separator */
            padding-top: 15px;
            align-items: center;
            flex-wrap: wrap; /* Allow actions to wrap */
        }
        .post-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #555e64; /* Cool gray for action text */
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            padding: 8px 10px; /* Consistent padding */
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }
        .post-actions button i { font-size: 1.2rem; margin-right: 8px; color: #8b0000; transition: color 0.2s; }
        .post-actions button:hover { background-color: #f0f0f0; }
        .post-actions button:hover i, .post-actions button:hover span { color: #6a0000; }
        .like-btn.liked i { color: #e74c3c !important; /* Brighter, distinct red for liked */ }
        .delete-post-btn { margin-left: auto !important; } /* Ensure it stays right */
        .delete-post-btn i { color: #c0392b !important; } /* Specific delete icon color */
        .delete-post-btn:hover i, .delete-post-btn:hover span { color: #a52f23 !important; }


        /* Comments Area */
        .comments-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #dde2e6; /* Dashed line for comments section */
        }
        .comments-list .comment {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa; /* Slightly off-white for comments */
            border-radius: 8px;
            border: 1px solid #e9ecef; /* Subtle border */
            font-size: 0.95rem;
        }
        .comment-header { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .comment-header img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .comment-header strong { font-size: 0.9rem; color: #333; font-weight: 600; font-family: inherit; } /* Sans-serif for username */
        .comment-header .timestamp { font-size: 0.8rem; color: #888; margin-left: auto; }
        .comment-content p { margin: 0 0 8px 0; color: #555; white-space: pre-wrap; line-height: 1.6; }
        .comment-content img.comment-image {
            max-width: 220px; /* Adjusted */
            max-height: 160px; /* Adjusted */
            border-radius: 6px;
            margin-top: 8px;
            display: block;
            border: 1px solid #eee;
        }

        .comment-form-actual {
            display: flex;
            align-items: stretch; /* Align items to stretch vertically */
            margin-top: 10px;
            gap: 8px;
        }
        .comment-form-actual input[type="text"].comment-text-input {
            flex: 1;
            /* padding: 10px 12px; Inherits global */
            /* border: 1px solid #ddd; Inherits global */
            /* border-radius: 6px; Inherits global */
            font-size: 0.9rem;
            height: 42px; /* Explicit height */
            margin-bottom: 0; /* Override global margin */
        }
        .comment-image-upload-label {
            padding: 0 12px; /* Horizontal padding only */
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 42px; /* Match input height */
            transition: background-color 0.3s;
            margin-bottom: 0;
        }
        .comment-image-upload-label:hover { background-color: #e0e0e0; }
        .comment-image-upload-label i { color: #555; font-size: 1.1rem; }
        .comment-form-actual button.comment-submit-btn {
            /* background: #8b0000; Inherits .btn-primary */
            /* color: white; Inherits .btn-primary */
            /* border: none; Inherits .btn-primary */
            padding: 0 18px; /* Horizontal padding only */
            /* border-radius: 6px; Inherits global button */
            cursor: pointer;
            font-weight: bold;
            height: 42px; /* Match input height */
            font-size: 0.9rem;
        }
        /* .comment-form-actual button.comment-submit-btn:hover { background: #6a0000; } Inherits .btn-primary hover */
        .comment-image-preview {
            max-width: 100px;
            max-height: 100px;
            display: none;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            object-fit: cover;
        }
        .comment-upload-progress {
            font-size: 0.85em;
            margin-top: 8px;
            color: #555;
            display: none;
            width: 100%;
            text-align: left;
            padding-left: 5px;
        }

        .comment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px;
        }
        .reply-to-comment-btn { /* This is a button element */
            font-size: 0.85rem !important; /* Keep specificity */
            color: #555e64 !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 4px 6px !important; /* Smaller padding */
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .reply-to-comment-btn i {
            margin-right: 0 !important; /* Reset margin */
            font-size: 0.9em !important;
            color: #8b0000 !important;
        }
         .reply-to-comment-btn:hover, .reply-to-comment-btn:hover i, .reply-to-comment-btn:hover span {
            color: #6a0000 !important;
            text-decoration: underline;
        }
        .replies-list {
            margin-left: 20px; /* Indent replies */
            margin-top: 12px;
            padding-left: 15px;
            border-left: 2px solid #e9ecef; /* Visual cue for reply thread */
        }
        .comment-reply { /* A single reply item */
            border: 1px solid #f0f0f0;
            padding: 10px;
            background-color: #fff; /* Replies on white background for contrast */
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em; /* Slightly smaller than main comment */
        }
        .comment-reply .comment-header img {
            width: 30px;
            height: 30px;
        }
        .reply-form-container {
            margin-left: 0; /* Align with parent comment's action */
            margin-top: 10px;
        }
        .reply-form-actual {
            display: flex;
            gap: 8px;
            align-items: stretch; /* Stretch for consistent height */
        }
        .reply-form-actual input.reply-text-input {
            flex: 1;
            padding: 8px 10px;
            /* border: 1px solid #ccc; Inherits global */
            /* border-radius: 6px; Inherits global */
            font-size: 0.9em;
            height: 40px; /* Explicit height */
             margin-bottom: 0;
        }
        .reply-form-actual button.reply-submit-btn {
            padding: 0 15px;
            background: #28a745; /* Green for reply confirm */
            color: white;
            /* border: none; Inherits global */
            /* border-radius: 6px; Inherits global */
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            height: 40px;
        }
        .reply-form-actual button.reply-submit-btn:hover { background: #218838; }

        /* Disabled button states are handled by global button style */


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            html { font-size: 15px; } /* Slightly smaller base on mobile */

            .desktop-nav { display: none; }
            .bottom-nav { display: flex; } /* Show bottom nav */

            .header {
                justify-content: space-between; /* Align items to sides */
                padding: 15px;
            }
            .header-logo {
                position: static; /* No longer absolute */
                transform: none;
                height: 50px; /* Smaller logo */
                width: 50px;
                margin-right: 10px;
            }
            .header-text-content {
                flex-grow: 1;
                text-align: center;
                margin-left: 0;
                margin-right: 40px; /* Space for a potential menu toggle on the right */
            }
             /* Add a menu toggle button for mobile header if not using bottom nav for menu */
            /* This seems to be handled by bottomNavMenuBtn for the side menu */


            .header h1 {
                font-size: 1.5rem; /* Adjusted for mobile */
                letter-spacing: 1.5px;
                margin-bottom: 3px;
            }
            .header h2 {
                font-size: 0.85rem; /* Adjusted for mobile */
                letter-spacing: 0.2px;
                color: #f0f0f0;
            }

            .user-info { flex-direction: column; text-align: center; }
            .user-info #logoutBtn {
                /* display: none !important; This was in original, but seems like it should be visible */
                margin-top: 10px;
            }

            .container { padding: 20px 10px; }
            .card { padding: 20px; margin-bottom: 20px; }
            /* .card-header class is available for use if needed */
            .posts-container h3 { font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 10px; }

            .post-header img { width: 40px; height: 40px; }
            .post-header strong { font-size: 1rem; }
            .post-header span.timestamp { font-size: 0.8rem; }
            .post-content p { font-size: 0.95rem; }

            .login-section h1 {font-size: 1.6rem;}
            .login-section p {font-size: 1rem;}
            .login-btn {max-width: 100%;}

            .post-form h3 {font-size: 1.3rem;}

            .comments-list .comment { padding: 12px; font-size: 0.9rem; }
            .comment-header img {width: 30px; height: 30px;}
            .comment-header strong {font-size: 0.85rem;}

            .replies-list { margin-left: 15px; padding-left: 10px; }
            .comment-reply { padding: 8px; font-size: 0.85em; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.3rem; }
            .header h2 { font-size: 0.75rem; }
            .bottom-nav a span { font-size: 0.7rem; } /* Even smaller text if needed */
            .bottom-nav a i { font-size: 1.2rem; }

            .post-actions button { font-size: 0.85rem; padding: 6px 8px; }
            .post-actions button i { font-size: 1.1rem; }
        }

    </style>
</head>
<body>
    <nav class="mobile-menu" id="mobileMenu"> <!-- Added ID for easier JS targeting if needed -->
        <a href="index.html"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a>
        <a href="agnosia.html"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a>
        <a href="enigma.html"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a>
        <a href="emulate.html"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a>
        <a href="#post-form-container" class="nav-post-link"><i class="fas fa-pen-to-square"></i><span data-translate-key="post">Post</span></a>

        <div class="language-select-label">
            <i class="fas fa-language"></i><span data-translate-key="language">Language</span><i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.8em;"></i>
        </div>
        <div class="language-options">
            <a href="#" data-lang="en">English</a>
            <a href="#" data-lang="ne">नेपाली (Nepali)</a>
            <a href="#" data-lang="hi">हिन्दी (Hindi)</a>
        </div>

        <a href="#loginSection" id="mobileLoginLink"><i class="fas fa-sign-in-alt"></i><span data-translate-key="login">Login</span></a>
        <a href="#" id="mobileLogoutLink" style="display: none;"><i class="fas fa-sign-out-alt"></i><span data-translate-key="logout">Logout</span></a>
    </nav>

    <header class="header">
      <img src="images/logo.png" alt="Virat Swarup Logo" class="header-logo">
      <div class="header-text-content">
        <h1>VIRAT SWARUP</h1>
        <h2 data-translate-key="headerSubtitle">The Supreme Divine of Every Faith</h2>
      </div>
      <!-- Placeholder for a potential mobile menu toggle if not using bottom nav for it -->
      <!-- <button id="mobileMenuToggle" class="mobile-menu-toggle"><i class="fas fa-bars"></i></button> -->
    </header>

    <nav class="desktop-nav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a></li>
            <li><a href="agnosia.html"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a></li>
            <li><a href="enigma.html"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a></li>
            <li><a href="emulate.html"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a></li>
            <li><a href="#post-form-container" class="nav-post-link"><i class="fas fa-pen-to-square"></i><span data-translate-key="post">Post</span></a></li>
        </ul>
    </nav>

    <nav class="bottom-nav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a></li>
            <li><a href="agnosia.html"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a></li>
            <li><a href="enigma.html"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a></li>
            <li><a href="emulate.html"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a></li>
            <li><a href="#" id="bottomNavMenuBtn"><i class="fas fa-bars"></i><span data-translate-key="menu">Menu</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="login-section card" id="loginSection"> <!-- Added .card -->
            <h1 data-translate-key="welcomeTitle">Welcome</h1>
            <p style="margin-bottom: 20px; color: #555;" data-translate-key="signInToConnect">Sign in to share and connect.</p>
            <button class="login-btn google-btn" id="googleLoginBtn">
                <i class="fab fa-google"></i> <span data-translate-key="signInWithGoogle">Sign in with Google</span>
            </button>
            <button class="login-btn facebook-btn" id="facebookLoginBtn">
                <i class="fab fa-facebook-f"></i> <span data-translate-key="signInWithFacebook">Sign in with Facebook</span>
            </button>
        </div>

        <div class="app-section" id="appSection" style="display: none;"> <!-- Ensure this is hidden initially by JS or style -->
            <div class="user-info card" id="userInfoCard"> <!-- Added .card -->
                <img id="userPhoto" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="User Photo" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                <div>
                    <h2 id="userName"></h2>
                    <button id="logoutBtn" class="btn-primary" data-translate-key="logout">Logout</button> <!-- Added .btn-primary -->
                </div>
            </div>

            <div class="post-form card" id="post-form-container"> <!-- Added .card -->
                <h3 data-translate-key="createPostTitle">Create Post</h3>
                <textarea id="postContent" data-translate-key-placeholder="postPlaceholder"></textarea>

                <label for="postImageFile">
                    <i class="fas fa-image"></i> <span data-translate-key="addImageOptional">Add Image (Optional)</span>
                </label>
                <input type="file" id="postImageFile" accept="image/*" style="display: none;">
                <img id="imagePreview" src="#" alt="Image Preview">
                <div id="uploadProgressContainer" style="display: none;">
                    <p id="uploadProgressText"></p>
                </div>

                <button id="postBtn" class="btn-primary" data-translate-key="postButton">Post</button> <!-- Added .btn-primary -->
            </div>

            <div class="posts-container" id="postsContainer">
                <h3 data-translate-key="feedTitle">Feed</h3>
                <!-- Posts will be loaded here -->
            </div>
        </div>
    </div>

    <script>
    // --- START CLOUDINARY CONFIGURATION ---
    const CLOUDINARY_CLOUD_NAME = "ddjtcap4f";
    const CLOUDINARY_UPLOAD_PRESET = "public_uploader";
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    // --- END CLOUDINARY CONFIGURATION ---

    // --- START FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyCg4rPKO6h4VjZsGlaIm8gZbL0J4vJHTrw", // Keep your actual API key secure
      authDomain: "viratsawarup.firebaseapp.com",
      projectId: "viratsawarup",
      // storageBucket: "viratsawarup.appspot.com", // Often needed for Firebase Storage if used directly
      messagingSenderId: "264071748020",
      appId: "1:264071748020:web:c939e9a9cdc14e80f77ae1",
      measurementId: "G-7GJQPJCR1L"
    };
    // --- END FIREBASE CONFIGURATION ---

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- START TRANSLATION DATA & LOGIC ---
    const translations = {
        en: {
            headerSubtitle: "The Supreme Divine of Every Faith",
            home: "Home",
            agnosia: "Agnosia",
            enigma: "Enigma",
            emulate: "Emulate",
            post: "Post",
            language: "Language",
            login: "Login",
            logout: "Logout",
            menu: "Menu",
            welcomeTitle: "Welcome",
            signInToConnect: "Sign in to share and connect.",
            signInWithGoogle: "Sign in with Google",
            signInWithFacebook: "Sign in with Facebook",
            createPostTitle: "Create Post",
            postPlaceholder: "What's on your mind, Virat Bhakt?",
            addImageOptional: "Add Image (Optional)",
            postButton: "Post",
            postingButton: "Posting...",
            feedTitle: "Feed",
            noPosts: "No posts yet. Be the first to share!",
            errorLoadingPosts: "Error loading posts.",
            loginToSeeFeed: "Please log in to see the feed.",
            likes: "Likes",
            comments: "Comments",
            deleteAction: "Delete",
            replyAction: "Reply",
            addCommentPlaceholder: "Add a comment...",
            commentPostButton: "Post", // For comment form
            noCommentsYet: "No comments yet.",
            writeReplyPlaceholder: "Write a reply...",
            replyPostButton: "Post Reply",
            uploadingImage: "Uploading image...",
            imageUploaded: "Image uploaded!",
            uploadFailed: "Upload failed.",
            deletePostConfirm: "Are you sure you want to delete this post?",
            postContentRequired: "Post content or an image is required!",
            loginRequiredToPost: "You must be logged in to post!",
            loginRequiredToComment: "Please log in to comment.",
            commentContentRequired: "Comment text or an image is required.",
            loginRequiredToReply: "Please log in to reply.",
            replyTextRequired: "Reply text cannot be empty.",
            loginRequiredToLike: "Please log in to like posts.",
            signInError: "Sign-in error",
            postError: "Error creating post"
        },
        ne: {
            headerSubtitle: "हरेक आस्थाका सर्वोच्च परमात्मा",
            home: "गृहपृष्ठ",
            agnosia: "अज्ञानता",
            enigma: "पहेली",
            emulate: "अनुकरण",
            post: "पोस्ट",
            language: "भाषा",
            login: "लग - इन",
            logout: "लग - आउट",
            menu: "मेनु",
            welcomeTitle: "स्वागत छ",
            signInToConnect: "साझा गर्न र जडान गर्न साइन इन गर्नुहोस्।",
            signInWithGoogle: "Google बाट साइन इन गर्नुहोस्",
            signInWithFacebook: "Facebook बाट साइन इन गर्नुहोस्",
            createPostTitle: "पोस्ट सिर्जना गर्नुहोस्",
            postPlaceholder: "मनमा के छ, विराट भक्त?",
            addImageOptional: "फोटो थप्नुहोस् (ऐच्छिक)",
            postButton: "पोस्ट गर्नुहोस्",
            postingButton: "पोस्ट गर्दै...",
            feedTitle: "फिड",
            noPosts: "अहिलेसम्म कुनै पोस्ट छैन। साझा गर्ने पहिलो व्यक्ति बन्नुहोस्!",
            errorLoadingPosts: "पोस्टहरू लोड गर्दा त्रुटि भयो।",
            loginToSeeFeed: "फिड हेर्न कृपया लग इन गर्नुहोस्।",
            likes: "लाइकहरू",
            comments: "टिप्पणीहरू",
            deleteAction: "मेटाउनुहोस्",
            replyAction: "जवाफ दिनुहोस्",
            addCommentPlaceholder: "टिप्पणी थप्नुहोस्...",
            commentPostButton: "पोस्ट",
            noCommentsYet: "अहिलेसम्म कुनै टिप्पणी छैन।",
            writeReplyPlaceholder: "जवाफ लेख्नुहोस्...",
            replyPostButton: "जवाफ पोस्ट गर्नुहोस्",
            uploadingImage: "फोटो अपलोड हुँदैछ...",
            imageUploaded: "फोटो अपलोड भयो!",
            uploadFailed: "अपलोड असफल भयो।",
            deletePostConfirm: "के तपाई साँच्चै यो पोस्ट मेटाउन चाहनुहुन्छ?",
            postContentRequired: "पोस्ट सामग्री वा फोटो आवश्यक छ!",
            loginRequiredToPost: "पोस्ट गर्न तपाईं लग इन हुनुपर्छ!",
            loginRequiredToComment: "कृपया टिप्पणी गर्न लग इन गर्नुहोस्।",
            commentContentRequired: "टिप्पणी पाठ वा फोटो आवश्यक छ।",
            loginRequiredToReply: "कृपया जवाफ दिन लग इन गर्नुहोस्।",
            replyTextRequired: "जवाफ खाली हुन सक्दैन।",
            loginRequiredToLike: "पोस्ट लाइक गर्न कृपया लग इन गर्नुहोस्。",
            signInError: "साइन-इन त्रुटि",
            postError: "पोस्ट बनाउँदा त्रुटि"
        },
        hi: {
            headerSubtitle: "हर आस्था के सर्वोच्च परमात्मा",
            home: "होम",
            agnosia: "अज्ञान",
            enigma: "पहेली",
            emulate: "अनुकरण",
            post: "पोस्ट",
            language: "भाषा",
            login: "लॉग इन करें",
            logout: "लॉग आउट करें",
            menu: "मेन्यू",
            welcomeTitle: "स्वागत है",
            signInToConnect: "साझा करने और जुड़ने के लिए साइन इन करें।",
            signInWithGoogle: "Google से साइन इन करें",
            signInWithFacebook: "Facebook से साइन इन करें",
            createPostTitle: "पोस्ट बनाएं",
            postPlaceholder: "आपके मन में क्या है, विराट भक्त?",
            addImageOptional: "छवि जोड़ें (वैकल्पिक)",
            postButton: "पोस्ट करें",
            postingButton: "पोस्ट कर रहा है...",
            feedTitle: "फ़ीड",
            noPosts: "अभी तक कोई पोस्ट नहीं है। साझा करने वाले पहले व्यक्ति बनें!",
            errorLoadingPosts: "पोस्ट लोड करने में त्रुटि।",
            loginToSeeFeed: "फ़ीड देखने के लिए कृपया लॉग इन करें।",
            likes: "लाइक",
            comments: "टिप्पणियाँ",
            deleteAction: "हटाएं",
            replyAction: "उत्तर दें",
            addCommentPlaceholder: "एक टिप्पणी जोड़ें...",
            commentPostButton: "पोस्ट",
            noCommentsYet: "अभी तक कोई टिप्पणी नहीं है।",
            writeReplyPlaceholder: "एक उत्तर लिखें...",
            replyPostButton: "उत्तर पोस्ट करें",
            uploadingImage: "छवि अपलोड हो रही है...",
            imageUploaded: "छवि अपलोड हो गई!",
            uploadFailed: "अपलोड विफल रहा।",
            deletePostConfirm: "क्या आप वाकई इस पोस्ट को हटाना चाहते हैं?",
            postContentRequired: "पोस्ट सामग्री या एक छवि आवश्यक है!",
            loginRequiredToPost: "पोस्ट करने के लिए आपको लॉग इन होना चाहिए!",
            loginRequiredToComment: "टिप्पणी करने के लिए कृपया लॉग इन करें।",
            commentContentRequired: "टिप्पणी पाठ या एक छवि आवश्यक है।",
            loginRequiredToReply: "उत्तर देने के लिए कृपया लॉग इन करें।",
            replyTextRequired: "उत्तर पाठ खाली नहीं हो सकता।",
            loginRequiredToLike: "पोस्ट पसंद करने के लिए कृपया लॉग इन करें।",
            signInError: "साइन-इन में त्रुटि",
            postError: "पोस्ट बनाने में त्रुटि"
        }
    };

    let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';

    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('selectedLanguage', lang);
        applyTranslations();
        document.querySelectorAll('.language-options a').forEach(a => {
            a.classList.remove('lang-active');
            if (a.dataset.lang === lang) {
                a.classList.add('lang-active');
            }
        });
        if (auth.currentUser) {
            loadPosts();
        } else {
            const loginMessageKey = 'loginToSeeFeed';
            const translatedLoginMessage = translations[currentLanguage]?.[loginMessageKey] || translations.en[loginMessageKey];
             if(elements.postsContainer && elements.appSection.style.display === 'none') { // Check if appSection is hidden
                elements.postsContainer.innerHTML = `<h3 data-translate-key="feedTitle">${translations[currentLanguage]?.feedTitle || translations.en.feedTitle}</h3><p class="empty-feed-message">${translatedLoginMessage}</p>`;
            }
        }
         // Update HTML lang attribute
        document.documentElement.lang = lang;
    }

    function _(key, fallbackLang = 'en') {
        return translations[currentLanguage]?.[key] || translations[fallbackLang]?.[key] || key;
    }

    function applyTranslations() {
        document.querySelectorAll('[data-translate-key]').forEach(element => {
            const key = element.dataset.translateKey;
            element.textContent = _(key);
        });
        document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
            const key = element.dataset.translateKeyPlaceholder;
            element.placeholder = _(key);
        });
        if (elements.postBtn && !elements.postBtn.disabled) {
            elements.postBtn.textContent = _('postButton');
        }
        // For dynamic title (though it's better to set once)
        // document.title = _('pageTitle', 'en'); // Example if you had a pageTitle key
    }
    // --- END TRANSLATION LOGIC ---


    const elements = {
        loginSection: document.getElementById('loginSection'),
        appSection: document.getElementById('appSection'),
        googleLoginBtn: document.getElementById('googleLoginBtn'),
        facebookLoginBtn: document.getElementById('facebookLoginBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        userPhoto: document.getElementById('userPhoto'),
        userName: document.getElementById('userName'),
        postBtn: document.getElementById('postBtn'),
        postContent: document.getElementById('postContent'),
        postsContainer: document.getElementById('postsContainer'),
        mobileMenu: document.getElementById('mobileMenu'),
        postImageFile: document.getElementById('postImageFile'),
        imagePreview: document.getElementById('imagePreview'),
        uploadProgressContainer: document.getElementById('uploadProgressContainer'),
        uploadProgressText: document.getElementById('uploadProgressText'),
        mobileLoginLink: document.getElementById('mobileLoginLink'),
        mobileLogoutLink: document.getElementById('mobileLogoutLink'),
        bottomNavMenuBtn: document.getElementById('bottomNavMenuBtn'),
        languageSelectLabel: document.querySelector('.language-select-label'),
        languageOptionsDiv: document.querySelector('.language-options')
    };

    if (elements.languageSelectLabel && elements.languageOptionsDiv) {
        elements.languageSelectLabel.addEventListener('click', () => {
            const optionsDiv = elements.languageOptionsDiv;
            optionsDiv.style.display = optionsDiv.style.display === 'none' || optionsDiv.style.display === '' ? 'block' : 'none';
        });
    }

    document.querySelectorAll('.language-options a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const lang = e.currentTarget.dataset.lang;
            setLanguage(lang);
            if (elements.languageOptionsDiv) elements.languageOptionsDiv.style.display = 'none';
        });
    });


    if (elements.postImageFile) {
        elements.postImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (elements.imagePreview) {
                        elements.imagePreview.src = event.target.result;
                        elements.imagePreview.style.display = 'block';
                    }
                }
                reader.readAsDataURL(file);
            } else {
                if (elements.imagePreview) {
                    elements.imagePreview.src = '#';
                    elements.imagePreview.style.display = 'none';
                }
            }
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            if(elements.loginSection) elements.loginSection.style.display = 'none';
            if(elements.appSection) elements.appSection.style.display = 'block'; // Ensure this is block not inheriting from .card initially
            if(elements.userPhoto) elements.userPhoto.src = user.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
            if(elements.userName) elements.userName.textContent = user.displayName || 'User';

            if (elements.mobileLoginLink) elements.mobileLoginLink.style.display = 'none';
            if (elements.mobileLogoutLink) elements.mobileLogoutLink.style.display = 'flex';

            loadPosts();
        } else {
            if(elements.loginSection) elements.loginSection.style.display = 'block'; // This should be .card, so block is fine
            if(elements.appSection) elements.appSection.style.display = 'none';
            if(elements.postsContainer) {
                 elements.postsContainer.innerHTML = `<h3 data-translate-key="feedTitle">${_('feedTitle')}</h3><p class="empty-feed-message">${_('loginToSeeFeed')}</p>`;
            }

            if (elements.mobileLoginLink) elements.mobileLoginLink.style.display = 'flex';
            if (elements.mobileLogoutLink) elements.mobileLogoutLink.style.display = 'none';

            if (postsUnsubscribe) {
                postsUnsubscribe();
                postsUnsubscribe = null;
            }
        }
        applyTranslations();
    });

    async function handleAuth(provider) {
        try {
            await auth.signInWithPopup(provider);
        } catch (error) {
            console.error("Login Error:", error);
            if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                return;
            }
            alert(_('signInError') + `: ${error.message}`);
        }
    }

    if (elements.googleLoginBtn) elements.googleLoginBtn.addEventListener('click', () => handleAuth(new firebase.auth.GoogleAuthProvider()));
    if (elements.facebookLoginBtn) elements.facebookLoginBtn.addEventListener('click', () => {
        alert("Facebook login requires additional developer setup and permissions review. Please use Google Sign-In for now.");
    });

    if (elements.logoutBtn) elements.logoutBtn.addEventListener('click', () => auth.signOut());

    if (elements.mobileLogoutLink) {
        elements.mobileLogoutLink.addEventListener('click', (event) => {
            event.preventDefault();
            auth.signOut();
            if (elements.mobileMenu && elements.mobileMenu.classList.contains('active')) {
                toggleMenu();
            }
        });
    }

    if (elements.postBtn) {
        elements.postBtn.addEventListener('click', async () => {
            const content = elements.postContent ? elements.postContent.value.trim() : "";
            const imageFile = elements.postImageFile ? elements.postImageFile.files[0] : null;
            const currentUser = auth.currentUser;

            if (!content && !imageFile) {
                alert(_('postContentRequired'));
                return;
            }
            if (!currentUser) {
                alert(_('loginRequiredToPost'));
                return;
            }

            elements.postBtn.disabled = true;
            elements.postBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${_('postingButton')}`; // Added spinner
            if(elements.uploadProgressContainer) elements.uploadProgressContainer.style.display = 'none';
            if(elements.uploadProgressText) elements.uploadProgressText.textContent = '';

            try {
                let imageUrl = null;
                let imagePublicId = null;

                if (imageFile) {
                    if(elements.uploadProgressContainer) elements.uploadProgressContainer.style.display = 'block';
                    if(elements.uploadProgressText) elements.uploadProgressText.textContent = _('uploadingImage');
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Cloudinary upload failed: ${errorData.error.message || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    imageUrl = data.secure_url;
                    imagePublicId = data.public_id;
                    if(elements.uploadProgressText) elements.uploadProgressText.textContent = _('imageUploaded');
                }

                const postData = {
                    content: content || "",
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Anonymous User',
                    userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: [],
                    comments: [] // Initialize as empty array
                };
                if (imageUrl) {
                    postData.imageUrl = imageUrl;
                    if (imagePublicId) postData.imagePublicId = imagePublicId;
                }

                await db.collection('posts').add(postData);

                if(elements.postContent) elements.postContent.value = '';
                if(elements.postImageFile) elements.postImageFile.value = null; // Reset file input
                if(elements.imagePreview) {
                    elements.imagePreview.src = '#';
                    elements.imagePreview.style.display = 'none';
                }
            } catch (error) {
                console.error("Post Error:", error);
                alert(_('postError') + `: ${error.message}`);
                if(elements.uploadProgressText && elements.uploadProgressContainer && elements.uploadProgressContainer.style.display === 'block') {
                     elements.uploadProgressText.textContent = _('uploadFailed');
                }
            } finally {
                if(elements.postBtn) {
                    elements.postBtn.disabled = false;
                    elements.postBtn.textContent = _('postButton'); // Reset text
                }
                setTimeout(() => {
                    if(elements.uploadProgressContainer && elements.uploadProgressText) {
                        // Only hide if not showing a failure message
                        if (elements.uploadProgressText.textContent && !elements.uploadProgressText.textContent.toLowerCase().includes('failed')) {
                            elements.uploadProgressContainer.style.display = 'none';
                            elements.uploadProgressText.textContent = '';
                        }
                    }
                }, 3000);
            }
        });
    }

    let postsUnsubscribe = null;
    function loadPosts() {
        if (postsUnsubscribe) postsUnsubscribe();

        // Ensure feed title element exists or create it
        let feedTitleElement = elements.postsContainer.querySelector('h3[data-translate-key="feedTitle"]');
        if (!feedTitleElement) {
            feedTitleElement = document.createElement('h3');
            feedTitleElement.setAttribute('data-translate-key', 'feedTitle');
            // Prepend if not first child or if postsContainer is empty
            if (!elements.postsContainer.firstChild || elements.postsContainer.firstChild.nodeName !== 'H3') {
                 elements.postsContainer.prepend(feedTitleElement);
            }
        }
        feedTitleElement.textContent = _('feedTitle');


        postsUnsubscribe = db.collection('posts')
          .orderBy('timestamp', 'desc')
          .onSnapshot(snapshot => {
              if (elements.postsContainer) {
                  const existingPosts = elements.postsContainer.querySelectorAll('.post, .empty-feed-message, .error-loading-message');
                  existingPosts.forEach(el => el.remove());

                  if (snapshot.empty) {
                      const p = document.createElement('p');
                      p.className = 'empty-feed-message'; // For styling if needed
                      p.textContent = _('noPosts');
                      elements.postsContainer.appendChild(p);
                      return;
                  }
                  snapshot.forEach(doc => createPostElement(doc.id, doc.data()));
              }
          }, error => {
              console.error("Error loading posts: ", error);
              if (elements.postsContainer) {
                  const existingPosts = elements.postsContainer.querySelectorAll('.post, .empty-feed-message, .error-loading-message');
                  existingPosts.forEach(el => el.remove());
                  const p = document.createElement('p');
                  p.className = 'error-loading-message'; // For styling if needed
                  p.textContent = _('errorLoadingPosts');
                  elements.postsContainer.appendChild(p);
              }
          });
    }

    function createPostElement(postId, post) {
        const currentUser = auth.currentUser;
        const isLiked = currentUser && post.likes && post.likes.includes(currentUser.uid);
        const postDiv = document.createElement('div');
        postDiv.className = 'post card'; // Added .card
        postDiv.setAttribute('data-post-id', postId);

        const formattedTimestamp = post.timestamp && typeof post.timestamp.toDate === 'function'
                                ? post.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0], { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'})
                                : (post.timestamp ? new Date(post.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

        let contentHTML = '';
        if (post.content) { // Ensure post.content is not empty before creating <p>
            contentHTML += `<p>${escapeHTML(post.content).replace(/\n/g, '<br>')}</p>`;
        }
        if (post.imageUrl) {
            contentHTML += `<img src="${post.imageUrl}" alt="Post image" class="post-image" onerror="this.style.display='none';">`;
        }
        if (!contentHTML) { // If both content and imageUrl are empty, provide a placeholder or leave it be
            contentHTML = `<p style="min-height:1.5em;"> </p>`; // Ensures div has some height
        }

        postDiv.innerHTML = `
            <div class="post-header">
                <img src="${post.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(post.userName)}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; this.alt='User avatar';">
                <strong>${escapeHTML(post.userName)}</strong>
                <span class="timestamp">${formattedTimestamp}</span>
            </div>
            <div class="post-content">${contentHTML}</div>
            <div class="post-actions">
                <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${postId}">
                    <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                    <span class="like-text">${post.likes ? post.likes.length : 0} ${_('likes')}</span>
                </button>
                <button class="comment-toggle-btn" data-post-id="${postId}">
                    <i class="far fa-comment"></i>
                    <span class="comment-text">${Array.isArray(post.comments) ? post.comments.length : 0} ${_('comments')}</span>
                </button>
                ${currentUser && post.userId === currentUser.uid ?
                    `<button class="delete-post-btn" data-post-id="${postId}" data-image-url="${post.imageUrl || ''}" data-image-public-id="${post.imagePublicId || ''}">
                        <i class="fas fa-trash"></i> <span data-translate-key="deleteAction">${_('deleteAction')}</span>
                     </button>` : ''}
            </div>
            <div class="comments-area" id="comments-area-${postId}" style="display: none;">
                <div class="comments-list" id="comments-list-${postId}"></div>
                <form class="comment-form-actual" data-post-id="${postId}">
                    <input type="text" name="commentText" class="comment-text-input" placeholder="${_('addCommentPlaceholder')}" autocomplete="off">
                    <label class="comment-image-upload-label" title="${_('addImageOptional')}">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" name="commentImageFile" class="comment-image-input" accept="image/*" style="display: none;">
                    </label>
                    <button type="submit" class="comment-submit-btn btn-primary">${_('commentPostButton')}</button> <!-- Added .btn-primary -->
                </form>
                <img src="#" alt="Comment image preview" class="comment-image-preview">
                <div class="comment-upload-progress"></div>
            </div>`;
        if (elements.postsContainer) {
            // Insert new posts after the H3 title
            const titleElement = elements.postsContainer.querySelector('h3');
            if (titleElement && titleElement.nextSibling) {
                elements.postsContainer.insertBefore(postDiv, titleElement.nextSibling);
            } else {
                elements.postsContainer.appendChild(postDiv);
            }
        }


        const commentImageInput = postDiv.querySelector('.comment-image-input');
        const commentImagePreview = postDiv.querySelector('.comment-image-preview');
        if (commentImageInput && commentImagePreview) {
            commentImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        commentImagePreview.src = event.target.result;
                        commentImagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    commentImagePreview.src = '#';
                    commentImagePreview.style.display = 'none';
                }
            });
        }

        const commentsList = postDiv.querySelector(`#comments-list-${postId}`);
        if (commentsList) {
            if (post.comments && Array.isArray(post.comments) && post.comments.length > 0) {
                const sortedComments = [...post.comments].sort((a,b) => {
                    const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                    const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                    return timeA - timeB; // Ascending order for comments
                });
                sortedComments.forEach(comment => renderComment(comment, commentsList, postId));
            } else {
                commentsList.innerHTML = `<p style="font-size:0.9em; color:#777; padding:5px 0; text-align:center;">${_('noCommentsYet')}</p>`;
            }
        }

        const likeBtn = postDiv.querySelector('.like-btn');
        if (likeBtn) likeBtn.addEventListener('click', () => handleLike(postId));
        const commentToggleBtn = postDiv.querySelector('.comment-toggle-btn');
        if (commentToggleBtn) commentToggleBtn.addEventListener('click', () => toggleComments(postId));
        const commentForm = postDiv.querySelector('.comment-form-actual');
        if (commentForm) commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, postId));
        const deleteBtn = postDiv.querySelector('.delete-post-btn');
        if (deleteBtn) deleteBtn.addEventListener('click', () => handleDeletePost(postId, deleteBtn.dataset.imageUrl, deleteBtn.dataset.imagePublicId));
    }

    async function handleDeletePost(postId, imageUrl, imagePublicId) {
        const currentUser = auth.currentUser;
        if (!currentUser) { alert(_('loginRequiredToPost')); return; }
        if (!confirm(_('deletePostConfirm'))) return;
        const postRef = db.collection('posts').doc(postId);
        try {
            const doc = await postRef.get();
            if (doc.exists && doc.data().userId === currentUser.uid) {
                // Note: Deleting images from Cloudinary usually requires backend/signed requests for security.
                // This frontend attempt might not work if Cloudinary API has restrictions for unsigned deletion by public_id.
                if (imagePublicId) {
                    console.warn(`Attempting to delete image with public_id: ${escapeHTML(imagePublicId)}. This typically requires a signed API call from a backend for security.`);
                    // Example: Simple deletion (might fail due to permissions if not configured for it)
                    // await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/destroy`, {
                    //     method: 'POST',
                    //     headers: { 'Content-Type': 'application/json' },
                    //     body: JSON.stringify({ public_id: imagePublicId, api_key: 'YOUR_API_KEY', timestamp: Date.now(), signature: 'GENERATED_SIGNATURE' })
                    // });
                    // For now, just log it. Proper deletion is a backend task.
                }
                await postRef.delete();
                // The post element will be removed by the onSnapshot listener automatically
            } else { alert("Permission denied or post not found."); }
        } catch (error) {
            console.error("Error deleting post:", error);
            alert("Failed to delete post: " + error.message);
        }
    }

    async function handleCommentSubmit(event, postId) {
        event.preventDefault();
        const currentUser = auth.currentUser;
        if (!currentUser) { alert(_('loginRequiredToComment')); return; }

        const form = event.target;
        const commentTextInput = form.querySelector('.comment-text-input');
        const commentImageInput = form.querySelector('.comment-image-input');
        const commentsArea = form.closest('.comments-area');
        const commentImagePreview = commentsArea ? commentsArea.querySelector('.comment-image-preview') : null;
        const commentUploadProgress = commentsArea ? commentsArea.querySelector('.comment-upload-progress') : null;

        const commentText = commentTextInput ? commentTextInput.value.trim() : "";
        const imageFile = commentImageInput ? commentImageInput.files[0] : null;

        if (!commentText && !imageFile) { alert(_('commentContentRequired')); return; }

        const submitButton = form.querySelector('.comment-submit-btn');
        if (submitButton) { submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${_('postingButton')}`; }
        if(commentUploadProgress) { commentUploadProgress.textContent = ''; commentUploadProgress.style.display = 'none';}

        let commentImageUrl = null;
        let commentImagePublicId = null;

        try {
            if (imageFile) {
                if(commentUploadProgress) { commentUploadProgress.textContent = _('uploadingImage'); commentUploadProgress.style.display = 'block'; }
                const formData = new FormData();
                formData.append('file', imageFile);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cloudinary comment image upload failed: ${errorData.error.message || 'Unknown error'}`);
                }
                const data = await response.json();
                commentImageUrl = data.secure_url;
                commentImagePublicId = data.public_id;
                if(commentUploadProgress) commentUploadProgress.textContent = _('imageUploaded');
            }

            const commentId = db.collection('posts').doc().id; // Generate a unique ID for the comment

            const newComment = {
                id: commentId, // Store the ID within the comment object
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                text: commentText || "",
                timestamp: new Date(), // Use JS Date for immediate client-side rendering, Firestore converts to Timestamp
                replies: [],
                imageUrl: commentImageUrl || null,
                imagePublicId: commentImagePublicId || null
            };

            const postRef = db.collection('posts').doc(postId);
            await postRef.update({
                comments: firebase.firestore.FieldValue.arrayUnion(newComment)
            });

            if (commentTextInput) commentTextInput.value = '';
            if (commentImageInput) commentImageInput.value = null; // Reset file input
            if (commentImagePreview) { commentImagePreview.src = '#'; commentImagePreview.style.display = 'none';}
            // Comment will be rendered by onSnapshot listener automatically
        } catch (error) {
            console.error("Error adding comment:", error);
            alert("Failed to add comment: " + error.message);
            if(commentUploadProgress && commentUploadProgress.style.display === 'block') {
                commentUploadProgress.textContent = _('uploadFailed');
            }
        } finally {
            if (submitButton) { submitButton.disabled = false; submitButton.textContent = _('commentPostButton'); }
            setTimeout(() => {
                if(commentUploadProgress && commentUploadProgress.style.display === 'block') {
                    if (commentUploadProgress.textContent && !commentUploadProgress.textContent.toLowerCase().includes('failed')) {
                        commentUploadProgress.style.display = 'none';
                        commentUploadProgress.textContent = '';
                    }
                }
            }, 3000);
        }
    }

    function toggleReplyForm(commentId) {
        const replyFormContainer = document.getElementById(`reply-form-container-${commentId}`);
        if (replyFormContainer) {
            const isHidden = replyFormContainer.style.display === 'none' || replyFormContainer.style.display === '';
            replyFormContainer.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                const inputField = replyFormContainer.querySelector('.reply-text-input');
                if (inputField) inputField.focus();
            }
        }
    }

    async function handleReplySubmit(event, postId, parentCommentId) {
        event.preventDefault();
        const currentUser = auth.currentUser;
        if (!currentUser) { alert(_('loginRequiredToReply')); return; }

        const form = event.target;
        const replyTextInput = form.querySelector('.reply-text-input');
        const replyText = replyTextInput ? replyTextInput.value.trim() : "";

        if (!replyText) { alert(_('replyTextRequired')); return; }

        const submitButton = form.querySelector('.reply-submit-btn');
        if (submitButton) { submitButton.disabled = true; submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${_('postingButton')}`; }

        const postRef = db.collection('posts').doc(postId);
        try {
             const newReply = {
                id: db.collection('posts').doc().id, // Unique ID for reply
                userId: currentUser.uid,
                userName: currentUser.displayName || 'User',
                userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                text: replyText,
                timestamp: new Date() // JS Date
            };

            await db.runTransaction(async (transaction) => {
                const postDoc = await transaction.get(postRef);
                if (!postDoc.exists) throw "Post document does not exist!";
                const postData = postDoc.data();
                let comments = postData.comments && Array.isArray(postData.comments) ? [...postData.comments] : []; // Make a mutable copy
                const commentIndex = comments.findIndex(c => c.id === parentCommentId);

                if (commentIndex > -1) {
                    const parentComment = comments[commentIndex];
                    const existingReplies = parentComment.replies && Array.isArray(parentComment.replies) ? [...parentComment.replies] : [];
                    existingReplies.push(newReply);
                    comments[commentIndex] = { ...parentComment, replies: existingReplies };
                    transaction.update(postRef, { comments: comments });
                } else {
                    throw "Parent comment not found!";
                }
            });
            if (replyTextInput) replyTextInput.value = '';
            // Reply will be rendered by onSnapshot listener
            // toggleReplyForm(parentCommentId); // Optionally close form
        } catch (error) {
            console.error("Error adding reply:", error);
            alert("Failed to add reply: " + error.message);
        } finally {
            if (submitButton) { submitButton.disabled = false; submitButton.textContent = _('replyPostButton');}
        }
    }

    function renderReply(reply, repliesListDiv) {
        const replyDiv = document.createElement('div');
        replyDiv.className = 'comment-reply';
        replyDiv.setAttribute('data-reply-id', reply.id);

        const replyTimestamp = reply.timestamp && typeof reply.timestamp.toDate === 'function'
                                ? reply.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0], { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'})
                                : (reply.timestamp ? new Date(reply.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

        let replyContentHTML = '';
        if (reply.text) {
            replyContentHTML = `<p>${escapeHTML(reply.text).replace(/\n/g, '<br>')}</p>`;
        }
        replyDiv.innerHTML = `
            <div class="comment-header">
                <img src="${reply.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(reply.userName || 'User')}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; this.alt='User avatar';">
                <strong>${escapeHTML(reply.userName) || 'User'}</strong>
                <span class="timestamp">${replyTimestamp}</span>
            </div>
            <div class="comment-content">${replyContentHTML || '<p style="min-height:1em;"> </p>'}</div>`;
        repliesListDiv.appendChild(replyDiv);
    }

    function renderComment(comment, commentsListElement, postId) {
        // Remove "No comments yet" message if it exists
        const noCommentP = commentsListElement.querySelector('p[style*="No comments yet"]');
        if(noCommentP) noCommentP.remove();

        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        commentDiv.setAttribute('data-comment-id', comment.id);

        const commentTimestamp = comment.timestamp && typeof comment.timestamp.toDate === 'function'
                                ? comment.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0], { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'})
                                : (comment.timestamp ? new Date(comment.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

        let commentContentHTML = '';
        if (comment.text) commentContentHTML += `<p>${escapeHTML(comment.text).replace(/\n/g, '<br>')}</p>`;
        if (comment.imageUrl) commentContentHTML += `<img src="${comment.imageUrl}" alt="Comment image" class="comment-image" onerror="this.style.display='none';">`;
        if (!commentContentHTML) commentContentHTML = `<p style="min-height:1.5em;"> </p>`;

        commentDiv.innerHTML = `
            <div class="comment-header">
                <img src="${comment.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(comment.userName || 'User')}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; this.alt='User avatar';">
                <strong>${escapeHTML(comment.userName) || 'User'}</strong>
                <span class="timestamp">${commentTimestamp}</span>
            </div>
            <div class="comment-content">${commentContentHTML}</div>
            <div class="comment-actions">
                <button class="reply-to-comment-btn" data-post-id="${postId}" data-comment-id="${comment.id}">
                    <i class="fas fa-reply"></i> <span data-translate-key="replyAction">${_('replyAction')}</span>
                </button>
            </div>
            <div class="replies-list" id="replies-list-${comment.id}"></div>
            <div class="reply-form-container" id="reply-form-container-${comment.id}" style="display: none;">
                <form class="reply-form-actual" data-post-id="${postId}" data-parent-comment-id="${comment.id}">
                    <input type="text" name="replyText" class="reply-text-input" placeholder="${_('writeReplyPlaceholder')}" autocomplete="off">
                    <button type="submit" class="reply-submit-btn">${_('replyPostButton')}</button>
                </form>
            </div>`;
        commentsListElement.appendChild(commentDiv);

        const repliesListDiv = commentDiv.querySelector(`#replies-list-${comment.id}`);
        if (comment.replies && Array.isArray(comment.replies) && comment.replies.length > 0) {
            const sortedReplies = [...comment.replies].sort((a,b) => {
                const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                return timeA - timeB; // Ascending for replies
            });
            sortedReplies.forEach(reply => renderReply(reply, repliesListDiv));
        }

        const replyButton = commentDiv.querySelector('.reply-to-comment-btn');
        if (replyButton) replyButton.addEventListener('click', () => toggleReplyForm(comment.id));
        const replyForm = commentDiv.querySelector('.reply-form-actual');
        if (replyForm) replyForm.addEventListener('submit', (e) => handleReplySubmit(e, postId, comment.id));
    }

    async function handleLike(postId) {
        const currentUser = auth.currentUser;
        if (!currentUser) { alert(_('loginRequiredToLike')); return; }
        const postRef = db.collection('posts').doc(postId);
        try {
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(postRef);
                if (!doc.exists) throw "Document does not exist!";
                const postData = doc.data();
                let currentLikes = postData.likes && Array.isArray(postData.likes) ? postData.likes : [];
                let newLikesArray;
                if (currentLikes.includes(currentUser.uid)) {
                    newLikesArray = currentLikes.filter(uid => uid !== currentUser.uid);
                } else {
                    newLikesArray = [...currentLikes, currentUser.uid];
                }
                transaction.update(postRef, { likes: newLikesArray });
            });
            // UI will update via onSnapshot
        } catch (error) {
            console.error("Like transaction failed:", error);
            alert("Failed to update like: " + error.message);
        }
    }

    function toggleComments(postId) {
        const commentsArea = document.getElementById(`comments-area-${postId}`);
        if (commentsArea) {
            const isHidden = commentsArea.style.display === 'none' || commentsArea.style.display === '';
            commentsArea.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
               const inputField = commentsArea.querySelector('input[name="commentText"]');
               if (inputField) inputField.focus();
            }
        }
    }

    function toggleMenu() {
        if (elements.mobileMenu) {
            elements.mobileMenu.classList.toggle('active');
            // Optional: Add/remove a class on body to prevent scrolling when menu is open
            // document.body.classList.toggle('mobile-menu-open');
        }
    }

    function closeMenuAndScroll(event) {
        const link = event.currentTarget;
        const isLanguageOption = link.closest('.language-options');

        if (!isLanguageOption && elements.mobileMenu && elements.mobileMenu.classList.contains('active')) {
            if (!link.closest('.language-select-label') && !link.dataset.lang) {
                 toggleMenu();
            }
        }

        const targetId = link.getAttribute('href');
        if (targetId && targetId.startsWith('#') && targetId.length > 1 && link.classList.contains('nav-post-link')) {
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                event.preventDefault();
                targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        }
    }


    if (elements.bottomNavMenuBtn) {
        elements.bottomNavMenuBtn.addEventListener('click', (event) => {
            event.preventDefault();
            toggleMenu();
        });
    }

    document.querySelectorAll('.mobile-menu a:not(.language-options a)').forEach(link => {
        link.addEventListener('click', (event) => {
            const href = link.getAttribute('href');
            if (href && href.startsWith('#') && href.length > 1 && link.id !== 'mobileLogoutLink' && !link.closest('.language-select-label')) {
                if(link.classList.contains('nav-post-link') || link.id === 'mobileLoginLink') {
                    closeMenuAndScroll(event); // This already calls toggleMenu
                } else { // For other # links that aren't special scroll links
                     if (elements.mobileMenu && elements.mobileMenu.classList.contains('active')) {
                        toggleMenu();
                    }
                }
            } else if (link.id === 'mobileLogoutLink') {
                // Handled by its own listener
            } else if (!link.closest('.language-select-label') && !link.dataset.lang) { // Standard page navigation
                if (elements.mobileMenu && elements.mobileMenu.classList.contains('active')) {
                    toggleMenu();
                }
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (elements.mobileMenu && elements.mobileMenu.classList.contains('active') &&
            elements.bottomNavMenuBtn && !elements.bottomNavMenuBtn.contains(e.target) && // Click not on toggle button
            !elements.mobileMenu.contains(e.target)) { // Click not inside menu
            toggleMenu();
        }
    });

    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        const s = String(str); // Ensure it's a string
        return s.replace(/[&<>"']/g, function (match) {
            switch (match) {
                case '&': return '&';
                case '<': return '<';
                case '>': return '>';
                case '"': return '"';
                case "'": return '''; // or '
                default: return match;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        setLanguage(currentLanguage);
        // Ensure app section is hidden by default if user not logged in,
        // auth.onAuthStateChanged will handle showing it.
        if (elements.appSection) elements.appSection.style.display = 'none';
        if (elements.loginSection) elements.loginSection.style.display = 'block'; // Show login by default
    });

    </script>
</body>
</html>
