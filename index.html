<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIRAT SWARUP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Georgia", serif;
        }

        body {
            background: #ffffff;
            color: #2c2c2c;
            padding-bottom: 70px;
            padding-top: 70px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px 20px;
            border-bottom: 1px solid #7a0000;
            background-color: #8b0000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            z-index: 1001;
            min-height: 60px;
        }

        .header-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .header-logo {
            height: 50px;
            width: 50px;
            object-fit: contain;
            margin-right: 10px;
        }

        .header-center {
            flex-grow: 1;
            text-align: center;
            min-width: 0;
            margin: 0 10px;
        }

        .header-center h1 {
            font-size: 28px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 2px;
            color: white;
            margin-top: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .header-center h2 {
            font-size: 14px;
            color: #f0f0f0;
            font-weight: 300;
            margin-top: 0;
            margin-bottom: 0;
            letter-spacing: 0.5px;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-right-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .language-switcher-header {
            position: relative;
        }
        .language-switcher-header #language-toggle-btn {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        .language-switcher-header #language-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .language-switcher-header #language-toggle-btn i.fa-globe{
            font-size: 16px;
        }
        .language-switcher-header #language-toggle-btn #current-selected-lang {
            font-weight: 500;
        }
        .language-switcher-header #language-toggle-btn i.fa-caret-down {
            margin-left: 2px;
            font-size: 11px;
        }
        .language-options-popup {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background-color: #800000;
            border: 1px solid #7a0000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1100;
            min-width: 120px;
            border-radius: 4px;
            overflow: hidden;
            display: none;
        }
        .language-options-popup a.lang-option {
            display: block;
            padding: 9px 12px;
            color: white;
            text-decoration: none;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        .language-options-popup a.lang-option:hover {
            background-color: #7a0000;
        }
        .language-options-popup a.lang-option.lang-active {
            font-weight: bold;
            background-color: #6a0000;
        }

        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            max-width: 80%;
            height: 100%;
            background: #8b0000;
            box-shadow: -3px 0 20px rgba(0, 0, 0, 0.25);
            transition: right 0.3s ease-in-out;
            padding-top: 20px;
            z-index: 1005;
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: #fff !important;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            cursor: pointer;
            font-size: 15px;
        }
        .mobile-menu i {
            width: 22px;
            font-size: 18px;
            color: #fff !important;
            text-align: center;
        }
        .mobile-menu a:last-child {
            border-bottom: none;
        }

        .desktop-nav {
            margin: 30px 0;
            display: block;
        }
        .desktop-nav ul {
            display: flex;
            justify-content: center;
            gap: 25px;
            list-style: none;
        }
        .desktop-nav a {
            color: #8b0000;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
            padding: 6px 12px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .desktop-nav a:hover {
            background-color: #8b0000;
            color: white;
        }

              .bottom-nav ul {
        display: flex;
        justify-content: space-around;
        list-style: none;
      }
      .bottom-nav a {
        color: #fff !important;
        font-size: 16px;
        text-decoration: none;
        display: flex;
        flex-direction: column; /* Make icon and text stack */
        align-items: center;
        gap: 4px; /* Space between icon and text */
        padding: 8px 10px; /* Adjusted padding */
        border-radius: 8px;
        transition: background 0.3s;
      }
      .bottom-nav a i {
        font-size: 20px; /* Icon size */
      }
      .bottom-nav a span {
        font-size: 12px; /* Text size smaller */
      }

      .bottom-nav a:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* डेस्कटॉप नेविगेशन */
      .desktop-nav {
        margin: 45px 0;
      }
      .desktop-nav ul {
        display: flex;
        justify-content: center;
        gap: 32px;
        list-style: none;
      }
      .desktop-nav a {
        color: #8b0000;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
      }

        @media (max-width: 768px) {
            body {
                padding-top: 60px;
                padding-bottom: 60px;
            }
            .header {
                padding: 5px 10px;
                min-height: 60px;
            }
            .header-logo {
                height: 40px;
                width: 40px;
                margin-right: 8px;
            }
            .header-center {
                text-align: left;
                margin-left: 0;
                margin-right: 5px;
            }
            .header-center h1 {
                font-size: 16px;
                letter-spacing: 1px;
                margin-bottom: 1px;
            }
            .header-center h2 {
                font-size: 10px;
                letter-spacing: 0.3px;
            }

            .header-right-controls {
                gap: 5px;
            }
            .language-switcher-header #language-toggle-btn {
                padding: 5px 7px;
                font-size: 12px;
            }
            .language-switcher-header #language-toggle-btn i.fa-globe{
                font-size: 15px;
            }

            .mobile-menu-toggle {
                display: block;
                font-size: 22px;
            }

            .desktop-nav { display: none; }
            .bottom-nav { display: flex; }

            .user-info #logoutBtn { display: block !important; font-size: 13px; padding: 6px 10px; }
            .user-info { padding: 10px; }
            .user-info img { width: 40px; height: 40px; margin-right: 10px; }
            .user-info div h2 { font-size: 16px; }
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1004;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .menu-overlay.active {
            display: block;
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
        }
        .login-section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; margin-top: 30px; }
        .login-section h1 { color: #333; margin-bottom: 15px; font-size: 22px; }
        .login-section p { margin-bottom: 20px; color: #555; font-size: 14px; }
        .login-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 15px; margin: 10px auto; width: 90%; max-width: 280px; color: white;
        }
        .login-btn.google-btn { background-color: #dd4b39; }
        .login-btn.google-btn:hover { background-color: #c23321; }
        .login-btn.facebook-btn { background-color: #3b5998; }
        .login-btn.facebook-btn:hover { background-color: #2d4373; }

        .app-section { display: none; }
        .user-info { display: flex; align-items: center; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .user-info img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; border: 2px solid #8b0000; }
        .user-info div h2 { margin: 0 0 5px 0; font-size: 18px; color: #333; }
        #logoutBtn { background: #8b0000; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        #logoutBtn:hover { background: #6a0000; }

        .post-form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .post-form h3 { margin-bottom: 15px; color: #333; font-size: 18px; }
        .post-form textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-family: inherit; font-size: 14px; min-height: 80px; }
        .post-form label[for="postImageFile"] { cursor: pointer; display: inline-block; margin-bottom: 10px; color: #555; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; font-size: 13px;}
        .post-form label[for="postImageFile"]:hover { background-color: #f0f0f0;}
        .post-form #imagePreview { max-width: 100%; max-height: 180px; display: none; margin-bottom: 10px; border-radius: 5px; border: 1px solid #eee; }
        #uploadProgressContainer { display: none; margin-bottom: 10px; }
        #uploadProgressText { font-size: 0.8em; text-align: center; color: #333; }
        .post-form button#postBtn { background: #8b0000; color: white; border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold; }
        .post-form button#postBtn:hover { background: #6a0000; }

        .posts-container h3 { margin-bottom: 20px; color: #333; font-size: 20px; border-bottom: 2px solid #8b0000; padding-bottom: 10px; }
        .post { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 20px; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .post-header img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 1px solid #eee; }
        .post-header strong { font-size: 15px; color: #333; }
        .post-header span.timestamp { font-size: 11px; color: #777; margin-left: auto; }
        .post-content p { font-size: 15px; line-height: 1.5; color: #444; margin-bottom: 10px; white-space: pre-wrap; }
        .post-content img.post-image { max-width: 100%; border-radius: 8px; margin-top: 10px; display: block; border: 1px solid #eee; }
        .post-actions { display: flex; margin-top: 10px; gap: 12px; border-top: 1px solid #eee; padding-top: 10px; align-items: center; }
        .post-actions button { background: none; border: none; cursor: pointer; color: #555; display: flex; align-items: center; font-size: 13px; padding: 5px; }
        .post-actions button i { font-size: 16px; margin-right: 6px; color: #8b0000; }
        .post-actions button:hover i, .post-actions button:hover span { color: #6a0000; }
        .like-btn.liked i { color: red !important; }
        
        /* Comment styles */
        .comment {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .comment-header img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .comment-header strong {
            font-size: 14px;
        }
        .comment-header .timestamp {
            font-size: 10px;
            color: #777;
            margin-left: auto;
        }
        .comment-content {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .comment-actions {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }
        .comment-reply {
            margin-left: 20px;
            margin-top: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .comment-form-actual {
            display: flex;
            margin-top: 10px;
            gap: 5px;
        }
        .comment-text-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .comment-submit-btn {
            padding: 8px 12px;
            background-color: #8b0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .comment-image-upload-label {
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
        }
        .comment-image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 5px;
            border-radius: 4px;
            display: none;
        }
        .comment-upload-progress {
            font-size: 12px;
            color: #555;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="menu-overlay" id="menuOverlay"></div>

    <header class="header">
        <div class="header-left">
            <img src="images/logo.png" alt="Virat Swarup Logo" class="header-logo">
        </div>
        <div class="header-center">
            <h1>VIRAT SWARUP</h1>
            <h2 data-translate-key="headerSubtitle">The Supreme Divine of Every Faith</h2>
        </div>
        <div class="header-right-controls">
            <div class="language-switcher-header">
                <button id="language-toggle-btn" aria-label="Select Language" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-globe"></i>
                    <span id="current-selected-lang">EN</span>
                    <i class="fas fa-caret-down"></i>
                </button>
                <div id="language-options-popup" class="language-options-popup">
                    <a href="#" onclick="setActiveLanguage('en'); return false;" data-lang="en" class="lang-option lang-active">English</a>
                    <a href="#" onclick="setActiveLanguage('ne'); return false;" data-lang="ne" class="lang-option">नेपाली</a>
                    <a href="#" onclick="setActiveLanguage('hi'); return false;" data-lang="hi" class="lang-option">हिन्दी</a>
                </div>
            </div>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <nav class="mobile-menu" id="mobileMenu" aria-hidden="true">
        <a href="index.html"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a>
        <a href="agnosia.html"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a>
        <a href="enigma.html"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a>
        <a href="emulate.html"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a>
        <a href="#post-form-container" class="nav-post-link"><i class="fas fa-pen-to-square"></i><span data-translate-key="post">Post</span></a>
        <a href="#loginSection" id="mobileLoginLink"><i class="fas fa-sign-in-alt"></i><span data-translate-key="login">Login</span></a>
        <a href="#" id="mobileLogoutLink" style="display: none;"><i class="fas fa-sign-out-alt"></i><span data-translate-key="logout">Logout</span></a>
    </nav>

    <nav class="desktop-nav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a></li>
            <li><a href="agnosia.html"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a></li>
            <li><a href="enigma.html"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a></li>
            <li><a href="emulate.html"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a></li>
            <li><a href="#post-form-container" class="nav-post-link"><i class="fas fa-pen-to-square"></i><span data-translate-key="post">Post</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="login-section" id="loginSection">
            <h1 data-translate-key="welcomeTitle">Welcome</h1>
            <p data-translate-key="signInToConnect">Sign in to share and connect.</p>
            <button class="login-btn google-btn" id="googleLoginBtn">
                <i class="fab fa-google"></i> <span data-translate-key="signInWithGoogle">Sign in with Google</span>
            </button>
            <button class="login-btn facebook-btn" id="facebookLoginBtn">
                <i class="fab fa-facebook-f"></i> <span data-translate-key="signInWithFacebook">Sign in with Facebook</span>
            </button>
        </div>

        <div class="app-section" id="appSection">
            <div class="user-info">
                <img id="userPhoto" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="User Photo" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                <div>
                    <h2 id="userName"></h2>
                </div>
            </div>

            <div class="post-form" id="post-form-container">
                <h3 data-translate-key="createPostTitle">Create Post</h3>
                <textarea id="postContent" data-translate-key-placeholder="postPlaceholder" placeholder="What's on your mind?"></textarea>

                <label for="postImageFile">
                    <i class="fas fa-image"></i> <span data-translate-key="addImageOptional">Add Image (Optional)</span>
                </label>
                <input type="file" id="postImageFile" accept="image/*" style="display: none;">
                <img id="imagePreview" src="#" alt="Image Preview" style="display:none;">
                <div id="uploadProgressContainer" style="display:none;">
                    <p id="uploadProgressText"></p>
                </div>

                <button id="postBtn" data-translate-key="postButton">Post</button>
            </div>

            <div class="posts-container" id="postsContainer">
                <h3 data-translate-key="feedTitle">Feed</h3>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <ul>
            <li><a href="index.html" data-nav-id="home"><i class="fas fa-home"></i><span data-translate-key="home">Home</span></a></li>
            <li><a href="agnosia.html" data-nav-id="agnosia"><i class="fas fa-eye-slash"></i><span data-translate-key="agnosia">Agnosia</span></a></li>
            <li><a href="enigma.html" data-nav-id="enigma"><i class="fas fa-question-circle"></i><span data-translate-key="enigma">Enigma</span></a></li>
            <li><a href="emulate.html" data-nav-id="emulate"><i class="fas fa-copy"></i><span data-translate-key="emulate">Emulate</span></a></li>
        </ul>
    </nav>

    <script>
        // Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = "ddjtcap4f";
        const CLOUDINARY_UPLOAD_PRESET = "public_uploader";
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCg4rPKO6h4VjZsGlaIm8gZbL0J4vJHTrw",
            authDomain: "viratsawarup.firebaseapp.com",
            projectId: "viratsawarup",
            messagingSenderId: "264071748020",
            appId: "1:264071748020:web:c939e9a9cdc14e80f77ae1",
            measurementId: "G-7GJQPJCR1L"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Translations
        const translations = {
            en: {
                headerSubtitle: "The Supreme Divine of Every Faith",
                home: "Home",
                agnosia: "Agnosia",
                enigma: "Enigma",
                emulate: "Emulate",
                post: "Post",
                language: "Language",
                login: "Login",
                logout: "Logout",
                menu: "Menu",
                welcomeTitle: "Welcome",
                signInToConnect: "Sign in to share and connect.",
                signInWithGoogle: "Sign in with Google",
                signInWithFacebook: "Sign in with Facebook",
                createPostTitle: "Create Post",
                postPlaceholder: "What's on your mind, Virat Bhakt?",
                addImageOptional: "Add Image (Optional)",
                postButton: "Post",
                postingButton: "Posting...",
                feedTitle: "Feed",
                noPosts: "No posts yet. Be the first to share!",
                errorLoadingPosts: "Error loading posts.",
                loginToSeeFeed: "Please log in to see the feed.",
                likes: "Likes",
                comments: "Comments",
                deleteAction: "Delete",
                replyAction: "Reply",
                addCommentPlaceholder: "Add a comment...",
                commentPostButton: "Post",
                noCommentsYet: "No comments yet.",
                writeReplyPlaceholder: "Write a reply...",
                replyPostButton: "Post Reply",
                uploadingImage: "Uploading image...",
                imageUploaded: "Image uploaded!",
                uploadFailed: "Upload failed.",
                deletePostConfirm: "Are you sure you want to delete this post?",
                postContentRequired: "Post content or an image is required!",
                loginRequiredToPost: "You must be logged in to post!",
                loginRequiredToComment: "Please log in to comment.",
                commentContentRequired: "Comment text or an image is required.",
                loginRequiredToReply: "Please log in to reply.",
                replyTextRequired: "Reply text cannot be empty.",
                loginRequiredToLike: "Please log in to like posts."
            },
            ne: {
                headerSubtitle: "हरेक आस्थाका सर्वोच्च परमात्मा",
                home: "गृहपृष्ठ",
                agnosia: "अज्ञानता",
                enigma: "पहेली",
                emulate: "अनुकरण",
                post: "पोस्ट",
                language: "भाषा",
                login: "लग - इन",
                logout: "लग - आउट",
                menu: "मेनु",
                welcomeTitle: "स्वागत छ",
                signInToConnect: "साझा गर्न र जडान गर्न साइन इन गर्नुहोस्।",
                signInWithGoogle: "Google बाट साइन इन गर्नुहोस्",
                signInWithFacebook: "Facebook बाट साइन इन गर्नुहोस्",
                createPostTitle: "पोस्ट सिर्जना गर्नुहोस्",
                postPlaceholder: "मनमा के छ, विराट भक्त?",
                addImageOptional: "फोटो थप्नुहोस् (ऐच्छिक)",
                postButton: "पोस्ट गर्नुहोस्",
                postingButton: "पोस्ट गर्दै...",
                feedTitle: "फिड",
                noPosts: "अहिलेसम्म कुनै पोस्ट छैन। साझा गर्ने पहिलो व्यक्ति बन्नुहोस्!",
                errorLoadingPosts: "पोस्टहरू लोड गर्दा त्रुटि भयो।",
                loginToSeeFeed: "फिड हेर्न कृपया लग इन गर्नुहोस्।",
                likes: "लाइकहरू",
                comments: "टिप्पणीहरू",
                deleteAction: "मेटाउनुहोस्",
                replyAction: "जवाफ दिनुहोस्",
                addCommentPlaceholder: "टिप्पणी थप्नुहोस्...",
                commentPostButton: "पोस्ट",
                noCommentsYet: "अहिलेसम्म कुनै टिप्पणी छैन।",
                writeReplyPlaceholder: "जवाफ लेख्नुहोस्...",
                replyPostButton: "जवाफ पोस्ट गर्नुहोस्",
                uploadingImage: "फोटो अपलोड हुँदैछ...",
                imageUploaded: "फोटो अपलोड भयो!",
                uploadFailed: "अपलोड असफल भयो।",
                deletePostConfirm: "के तपाई साँच्चै यो पोस्ट मेटाउन चाहनुहुन्छ?",
                postContentRequired: "पोस्ट सामग्री वा फोटो आवश्यक छ!",
                loginRequiredToPost: "पोस्ट गर्न तपाईं लग इन हुनुपर्छ!",
                loginRequiredToComment: "कृपया टिप्पणी गर्न लग इन गर्नुहोस्।",
                commentContentRequired: "टिप्पणी पाठ वा फोटो आवश्यक छ।",
                loginRequiredToReply: "कृपया जवाफ दिन लग इन गर्नुहोस्।",
                replyTextRequired: "जवाफ खाली हुन सक्दैन।",
                loginRequiredToLike: "पोस्ट लाइक गर्न कृपया लग इन गर्नुहोस्।"
            },
            hi: {
                headerSubtitle: "हर आस्था के सर्वोच्च परमात्मा",
                home: "होम",
                agnosia: "अज्ञान",
                enigma: "पहेली",
                emulate: "अनुकरण",
                post: "पोस्ट",
                language: "भाषा",
                login: "लॉग इन करें",
                logout: "लॉग आउट करें",
                menu: "मेन्यू",
                welcomeTitle: "स्वागत है",
                signInToConnect: "साझा करने और जुड़ने के लिए साइन इन करें।",
                signInWithGoogle: "Google से साइन इन करें",
                signInWithFacebook: "Facebook से साइन इन करें",
                createPostTitle: "पोस्ट बनाएं",
                postPlaceholder: "आपके मन में क्या है, विराट भक्त?",
                addImageOptional: "छवि जोड़ें (वैकल्पिक)",
                postButton: "पोस्ट करें",
                postingButton: "पोस्ट कर रहा है...",
                feedTitle: "फ़ीड",
                noPosts: "अभी तक कोई पोस्ट नहीं है। साझा करने वाले पहले व्यक्ति बनें!",
                errorLoadingPosts: "पोस्ट लोड करने में त्रुटि।",
                loginToSeeFeed: "फ़ीड देखने के लिए कृपया लॉग इन करें।",
                likes: "लाइक",
                comments: "टिप्पणियाँ",
                deleteAction: "हटाएं",
                replyAction: "उत्तर दें",
                addCommentPlaceholder: "एक टिप्पणी जोड़ें...",
                commentPostButton: "पोस्ट",
                noCommentsYet: "अभी तक कोई टिप्पणी नहीं है।",
                writeReplyPlaceholder: "एक उत्तर लिखें...",
                replyPostButton: "उत्तर पोस्ट करें",
                uploadingImage: "छवि अपलोड हो रही है...",
                imageUploaded: "छवि अपलोड हो गई!",
                uploadFailed: "अपलोड विफल रहा।",
                deletePostConfirm: "क्या आप वाकई इस पोस्ट को हटाना चाहते हैं?",
                postContentRequired: "पोस्ट सामग्री या एक छवि आवश्यक है!",
                loginRequiredToPost: "पोस्ट करने के लिए आपको लॉग इन होना चाहिए!",
                loginRequiredToComment: "टिप्पणी करने के लिए कृपया लॉग इन करें।",
                commentContentRequired: "टिप्पणी पाठ या एक छवि आवश्यक है।",
                loginRequiredToReply: "उत्तर देने के लिए कृपया लॉग इन करें।",
                replyTextRequired: "उत्तर पाठ खाली नहीं हो सकता।",
                loginRequiredToLike: "पोस्ट पसंद करने के लिए कृपया लॉग इन करें।"
            }
        };

        let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
        let postsUnsubscribe = null;

        // DOM elements
        const elements = {
            loginSection: document.getElementById('loginSection'),
            appSection: document.getElementById('appSection'),
            googleLoginBtn: document.getElementById('googleLoginBtn'),
            facebookLoginBtn: document.getElementById('facebookLoginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            userPhoto: document.getElementById('userPhoto'),
            userName: document.getElementById('userName'),
            postBtn: document.getElementById('postBtn'),
            postContent: document.getElementById('postContent'),
            postsContainer: document.getElementById('postsContainer'),
            mobileMenu: document.getElementById('mobileMenu'),
            postImageFile: document.getElementById('postImageFile'),
            imagePreview: document.getElementById('imagePreview'),
            uploadProgressContainer: document.getElementById('uploadProgressContainer'),
            uploadProgressText: document.getElementById('uploadProgressText'),
            mobileLoginLink: document.getElementById('mobileLoginLink'),
            mobileLogoutLink: document.getElementById('mobileLogoutLink'),
            mobileMenuToggle: document.getElementById('mobileMenuToggle'),
            menuOverlay: document.getElementById('menuOverlay'),
            languageToggleBtn: document.getElementById('language-toggle-btn'),
            languageOptionsPopup: document.getElementById('language-options-popup'),
            currentSelectedLangSpan: document.getElementById('current-selected-lang')
        };

        // Helper function to get translation
        function _(key, fallbackLang = 'en') {
            return translations[currentLanguage]?.[key] || translations[fallbackLang]?.[key] || key;
        }

        // Apply translations to the page
        function applyTranslations() {
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                element.textContent = _(key);
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                const key = element.dataset.translateKeyPlaceholder;
                element.placeholder = _(key);
            });
            if (elements.postBtn && !elements.postBtn.disabled) {
                elements.postBtn.textContent = _('postButton');
            }
        }

        // Set active language
        function setActiveLanguage(lang) {
            if (!translations[lang]) {
                console.warn(`Language ${lang} not found in translations.`);
                return;
            }
            currentLanguage = lang;
            localStorage.setItem('selectedLanguage', lang);
            applyTranslations();
            
            if (elements.currentSelectedLangSpan) {
                elements.currentSelectedLangSpan.textContent = lang.toUpperCase();
            }

            document.querySelectorAll('.language-options-popup .lang-option').forEach(opt => {
                opt.classList.remove('lang-active');
                if (opt.getAttribute('data-lang') === lang) {
                    opt.classList.add('lang-active');
                }
            });

            if (elements.languageOptionsPopup) {
                elements.languageOptionsPopup.style.display = 'none';
                if (elements.languageToggleBtn) elements.languageToggleBtn.setAttribute('aria-expanded', 'false');
            }
            
            // Reload posts to apply translations to dynamic content
            if (auth.currentUser) {
                loadPosts();
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const isActive = elements.mobileMenu.classList.toggle('active');
            elements.mobileMenuToggle.setAttribute('aria-expanded', isActive.toString());
            elements.mobileMenu.setAttribute('aria-hidden', (!isActive).toString());
            elements.menuOverlay.classList.toggle('active', isActive);
            document.body.style.overflow = isActive ? 'hidden' : '';
        }

        // Initialize event listeners
        function initEventListeners() {
            // Mobile menu toggle
            if (elements.mobileMenuToggle && elements.mobileMenu && elements.menuOverlay) {
                elements.mobileMenu.setAttribute('aria-hidden', 'true');
                elements.mobileMenuToggle.addEventListener('click', toggleMobileMenu);
                elements.menuOverlay.addEventListener('click', toggleMobileMenu);

                elements.mobileMenu.addEventListener('click', (event) => {
                    if (event.target.tagName === 'A' || event.target.closest('A')) {
                        if (elements.mobileMenu.classList.contains('active')) {
                            toggleMobileMenu();
                        }
                    }
                });
            }

            // Language switcher
            if (elements.languageToggleBtn && elements.languageOptionsPopup) {
                elements.languageToggleBtn.setAttribute('aria-expanded', 'false');
                elements.languageToggleBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const isCurrentlyVisible = elements.languageOptionsPopup.style.display === 'block';
                    elements.languageOptionsPopup.style.display = isCurrentlyVisible ? 'none' : 'block';
                    elements.languageToggleBtn.setAttribute('aria-expanded', (!isCurrentlyVisible).toString());
                });

                document.addEventListener('click', (event) => {
                    if (elements.languageOptionsPopup.style.display === 'block' &&
                        !elements.languageToggleBtn.contains(event.target) &&
                        !elements.languageOptionsPopup.contains(event.target)) {
                        elements.languageOptionsPopup.style.display = 'none';
                        elements.languageToggleBtn.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            // Image preview for post
            if (elements.postImageFile) {
                elements.postImageFile.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            if (elements.imagePreview) {
                                elements.imagePreview.src = event.target.result;
                                elements.imagePreview.style.display = 'block';
                            }
                        }
                        reader.readAsDataURL(file);
                    } else {
                        if (elements.imagePreview) {
                            elements.imagePreview.src = '#';
                            elements.imagePreview.style.display = 'none';
                        }
                    }
                });
            }

            // Login buttons
            if (elements.googleLoginBtn) {
                elements.googleLoginBtn.addEventListener('click', () => handleAuth(new firebase.auth.GoogleAuthProvider()));
            }
            
            if (elements.facebookLoginBtn) {
                elements.facebookLoginBtn.addEventListener('click', () => {
                    alert(_('signInWithFacebook') + " requires additional developer setup. Please use Google Sign-In.");
                });
            }

            // Logout button
            if (elements.logoutBtn) {
                elements.logoutBtn.addEventListener('click', () => auth.signOut());
            }

            // Mobile logout link
            if (elements.mobileLogoutLink) {
                elements.mobileLogoutLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    auth.signOut();
                    if (elements.mobileMenu && elements.mobileMenu.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                });
            }

            // Post button
            if (elements.postBtn) {
                elements.postBtn.addEventListener('click', createPost);
            }

            // Bottom nav active state
            const currentPagePath = window.location.pathname;
            const currentPageFilename = currentPagePath.substring(currentPagePath.lastIndexOf('/') + 1) || 'index.html';
            
            document.querySelectorAll('.bottom-nav a').forEach(link => {
                const hrefAttr = link.getAttribute('href');
                if (hrefAttr) {
                    const linkFilename = hrefAttr.substring(hrefAttr.lastIndexOf('/') + 1) || 'index.html';
                    if (linkFilename.toLowerCase() === currentPageFilename.toLowerCase()) {
                        link.classList.add('active-nav-item');
                    } else {
                        link.classList.remove('active-nav-item');
                    }
                }
            });
        }

        // Handle authentication
        async function handleAuth(provider) {
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Login Error:", error);
                if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                    return;
                }
                alert(_('signInError', 'en') + `: ${error.message}`);
            }
        }

        // Create a new post
        async function createPost() {
            const content = elements.postContent ? elements.postContent.value.trim() : "";
            const imageFile = elements.postImageFile ? elements.postImageFile.files[0] : null;
            const currentUser = auth.currentUser;

            if (!content && !imageFile) {
                alert(_('postContentRequired'));
                return;
            }
            if (!currentUser) {
                alert(_('loginRequiredToPost'));
                return;
            }

            elements.postBtn.disabled = true;
            elements.postBtn.textContent = _('postingButton');
            if(elements.uploadProgressContainer) elements.uploadProgressContainer.style.display = 'none';
            if(elements.uploadProgressText) elements.uploadProgressText.textContent = '';

            try {
                let imageUrl = null;
                let imagePublicId = null;

                if (imageFile) {
                    if(elements.uploadProgressContainer) elements.uploadProgressContainer.style.display = 'block';
                    if(elements.uploadProgressText) elements.uploadProgressText.textContent = _('uploadingImage');
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Cloudinary upload failed: ${errorData.error.message || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    imageUrl = data.secure_url;
                    imagePublicId = data.public_id;
                    if(elements.uploadProgressText) elements.uploadProgressText.textContent = _('imageUploaded');
                }

                const postData = {
                    content: content || "",
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Anonymous User',
                    userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: [],
                    comments: []
                };
                if (imageUrl) {
                    postData.imageUrl = imageUrl;
                    if (imagePublicId) postData.imagePublicId = imagePublicId;
                }

                await db.collection('posts').add(postData);

                if(elements.postContent) elements.postContent.value = '';
                if(elements.postImageFile) elements.postImageFile.value = null;
                if(elements.imagePreview) {
                    elements.imagePreview.src = '#';
                    elements.imagePreview.style.display = 'none';
                }
            } catch (error) {
                console.error("Post Error:", error);
                alert(_('postError', 'en') + `: ${error.message}`);
                if(elements.uploadProgressText && elements.uploadProgressContainer && elements.uploadProgressContainer.style.display === 'block') {
                     elements.uploadProgressText.textContent = _('uploadFailed');
                }
            } finally {
                if(elements.postBtn) {
                    elements.postBtn.disabled = false;
                    elements.postBtn.textContent = _('postButton');
                }
                setTimeout(() => {
                    if(elements.uploadProgressContainer && elements.uploadProgressText) {
                        if (!elements.uploadProgressText.textContent.toLowerCase().includes('failed')) {
                            elements.uploadProgressContainer.style.display = 'none';
                            elements.uploadProgressText.textContent = '';
                        }
                    }
                }, 3000);
            }
        }

        // Load posts from Firestore
        function loadPosts() {
            if (postsUnsubscribe) postsUnsubscribe();
            
            const feedTitleElement = elements.postsContainer.querySelector('h3') || document.createElement('h3');
            feedTitleElement.setAttribute('data-translate-key', 'feedTitle');
            feedTitleElement.textContent = _('feedTitle');

            postsUnsubscribe = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    if (elements.postsContainer) {
                        // Clear only posts, keep the title
                        const existingPosts = elements.postsContainer.querySelectorAll('.post, .no-posts-message, .error-loading-message');
                        existingPosts.forEach(el => el.remove());

                        if (!elements.postsContainer.querySelector('h3')) {
                            elements.postsContainer.prepend(feedTitleElement);
                        }

                        if (snapshot.empty) {
                            const p = document.createElement('p');
                            p.className = 'no-posts-message';
                            p.textContent = _('noPosts');
                            elements.postsContainer.appendChild(p);
                            return;
                        }
                        snapshot.forEach(doc => createPostElement(doc.id, doc.data()));
                    }
                }, error => {
                    console.error("Error loading posts: ", error);
                    if (elements.postsContainer) {
                        const existingPosts = elements.postsContainer.querySelectorAll('.post, .no-posts-message, .error-loading-message');
                        existingPosts.forEach(el => el.remove());
                        if (!elements.postsContainer.querySelector('h3')) {
                            elements.postsContainer.prepend(feedTitleElement);
                        }
                        const p = document.createElement('p');
                        p.className = 'error-loading-message';
                        p.textContent = _('errorLoadingPosts');
                        elements.postsContainer.appendChild(p);
                    }
                });
        }

        // Create post element for display
        function createPostElement(postId, post) {
            const currentUser = auth.currentUser;
            const isLiked = currentUser && post.likes && post.likes.includes(currentUser.uid);
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.setAttribute('data-post-id', postId);

            const formattedTimestamp = post.timestamp && typeof post.timestamp.toDate === 'function'
                                    ? post.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0])
                                    : (post.timestamp ? new Date(post.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

            let contentHTML = '';
            if (post.content) {
                contentHTML += `<p>${escapeHTML(post.content).replace(/\n/g, '<br>')}</p>`;
            }
            if (post.imageUrl) {
                contentHTML += `<img src="${post.imageUrl}" alt="Post image" class="post-image" onerror="this.style.display='none';">`;
            }
            postDiv.innerHTML = `
                <div class="post-header">
                    <img src="${post.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(post.userName)}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                    <div><strong>${escapeHTML(post.userName)}</strong></div>
                    <span class="timestamp">${formattedTimestamp}</span>
                </div>
                <div class="post-content">${contentHTML || '<p> </p>'}</div>
                <div class="post-actions">
                    <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${postId}">
                        <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                        <span class="like-text">${post.likes ? post.likes.length : 0} ${_('likes')}</span>
                    </button>
                    <button class="comment-toggle-btn" data-post-id="${postId}">
                        <i class="far fa-comment"></i>
                        <span class="comment-text">${post.comments ? post.comments.length : 0} ${_('comments')}</span>
                    </button>
                    ${currentUser && post.userId === currentUser.uid ?
                        `<button class="delete-post-btn" data-post-id="${postId}" data-image-url="${post.imageUrl || ''}" data-image-public-id="${post.imagePublicId || ''}" style="margin-left: auto; color: #cc0000;">
                            <i class="fas fa-trash"></i> <span data-translate-key="deleteAction">${_('deleteAction')}</span>
                         </button>` : ''}
                </div>
                <div class="comments-area" id="comments-area-${postId}" style="display: none;">
                    <div class="comments-list" id="comments-list-${postId}"></div>
                    <form class="comment-form-actual" data-post-id="${postId}">
                        <input type="text" name="commentText" class="comment-text-input" placeholder="${_('addCommentPlaceholder')}" autocomplete="off">
                        <label class="comment-image-upload-label" title="${_('addImageOptional')}">
                            <i class="fas fa-paperclip"></i>
                            <input type="file" name="commentImageFile" class="comment-image-input" accept="image/*" style="display: none;">
                        </label>
                        <button type="submit" class="comment-submit-btn">${_('commentPostButton')}</button>
                    </form>
                    <img src="#" alt="Comment image preview" class="comment-image-preview" style="display: none;">
                    <div class="comment-upload-progress" style="display: none;"></div>
                </div>`;
            if (elements.postsContainer) elements.postsContainer.appendChild(postDiv);

            // Set up comment image preview
            const commentImageInput = postDiv.querySelector('.comment-image-input');
            const commentImagePreview = postDiv.querySelector('.comment-image-preview');
            if (commentImageInput && commentImagePreview) {
                commentImageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            commentImagePreview.src = event.target.result;
                            commentImagePreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    } else {
                        commentImagePreview.src = '#';
                        commentImagePreview.style.display = 'none';
                    }
                });
            }

            // Load comments
            const commentsList = postDiv.querySelector(`#comments-list-${postId}`);
            if (commentsList) {
                if (post.comments && post.comments.length > 0) {
                    const sortedComments = [...post.comments].sort((a,b) => {
                        const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                        const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                        return timeA - timeB;
                    });
                    sortedComments.forEach(comment => renderComment(comment, commentsList, postId));
                } else {
                    commentsList.innerHTML = `<p style="font-size:0.9em; color:#777; padding:5px 0;">${_('noCommentsYet')}</p>`;
                }
            }

            // Set up event listeners for the post
            const likeBtn = postDiv.querySelector('.like-btn');
            if (likeBtn) likeBtn.addEventListener('click', () => handleLike(postId));
            
            const commentToggleBtn = postDiv.querySelector('.comment-toggle-btn');
            if (commentToggleBtn) commentToggleBtn.addEventListener('click', () => toggleComments(postId));
            
            const commentForm = postDiv.querySelector('.comment-form-actual');
            if (commentForm) commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, postId));
            
            const deleteBtn = postDiv.querySelector('.delete-post-btn');
            if (deleteBtn) deleteBtn.addEventListener('click', () => handleDeletePost(postId, deleteBtn.dataset.imageUrl, deleteBtn.dataset.imagePublicId));
        }

        // Handle like action
        async function handleLike(postId) {
            const currentUser = auth.currentUser;
            if (!currentUser) { alert(_('loginRequiredToLike')); return; }
            const postRef = db.collection('posts').doc(postId);
            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(postRef);
                    if (!doc.exists) throw "Document does not exist!";
                    const postData = doc.data();
                    let currentLikes = postData.likes || [];
                    let newLikesArray = currentLikes.includes(currentUser.uid)
                                       ? currentLikes.filter(uid => uid !== currentUser.uid)
                                       : [...currentLikes, currentUser.uid];
                    transaction.update(postRef, { likes: newLikesArray });
                });
            } catch (error) {
                console.error("Like transaction failed:", error);
                alert("Failed to update like: " + error.message);
            }
        }

        // Toggle comments visibility
        function toggleComments(postId) {
            const commentsArea = document.getElementById(`comments-area-${postId}`);
            if (commentsArea) {
                const isHidden = commentsArea.style.display === 'none' || commentsArea.style.display === '';
                commentsArea.style.display = isHidden ? 'block' : 'none';
                if (isHidden) {
                   const inputField = commentsArea.querySelector('input[name="commentText"]');
                   if (inputField) inputField.focus();
                }
            }
        }

        // Handle comment submission
        async function handleCommentSubmit(event, postId) {
            event.preventDefault();
            const currentUser = auth.currentUser;
            if (!currentUser) { alert(_('loginRequiredToComment')); return; }

            const form = event.target;
            const commentTextInput = form.querySelector('.comment-text-input');
            const commentImageInput = form.querySelector('.comment-image-input');
            const commentsArea = form.closest('.comments-area');
            const commentImagePreview = commentsArea ? commentsArea.querySelector('.comment-image-preview') : null;
            const commentUploadProgress = commentsArea ? commentsArea.querySelector('.comment-upload-progress') : null;

            const commentText = commentTextInput ? commentTextInput.value.trim() : "";
            const imageFile = commentImageInput ? commentImageInput.files[0] : null;

            if (!commentText && !imageFile) { alert(_('commentContentRequired')); return; }

            const submitButton = form.querySelector('.comment-submit-btn');
            if (submitButton) { submitButton.disabled = true; submitButton.textContent = _('postingButton'); }
            if(commentUploadProgress) { commentUploadProgress.textContent = ''; commentUploadProgress.style.display = 'none';}

            let commentImageUrl = null;
            let commentImagePublicId = null;

            try {
                if (imageFile) {
                    if(commentUploadProgress) { commentUploadProgress.textContent = _('uploadingImage'); commentUploadProgress.style.display = 'block'; }
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Cloudinary comment image upload failed: ${errorData.error.message || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    commentImageUrl = data.secure_url;
                    commentImagePublicId = data.public_id;
                    if(commentUploadProgress) commentUploadProgress.textContent = _('imageUploaded');
                }

                const commentId = db.collection('posts').doc().id;

                const newComment = {
                    id: commentId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'User',
                    userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                    text: commentText || "",
                    timestamp: new Date(),
                    replies: [],
                    imageUrl: commentImageUrl || null,
                    imagePublicId: commentImagePublicId || null
                };

                const postRef = db.collection('posts').doc(postId);
                await postRef.update({
                    comments: firebase.firestore.FieldValue.arrayUnion(newComment)
                });

                if (commentTextInput) commentTextInput.value = '';
                if (commentImageInput) commentImageInput.value = null;
                if (commentImagePreview) { commentImagePreview.src = '#'; commentImagePreview.style.display = 'none';}
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Failed to add comment: " + error.message);
                if(commentUploadProgress && commentUploadProgress.style.display === 'block') {
                    commentUploadProgress.textContent = _('uploadFailed');
                }
            } finally {
                if (submitButton) { submitButton.disabled = false; submitButton.textContent = _('commentPostButton'); }
                setTimeout(() => {
                    if(commentUploadProgress && commentUploadProgress.style.display === 'block') {
                        if (commentUploadProgress.textContent && !commentUploadProgress.textContent.toLowerCase().includes('failed')) {
                            commentUploadProgress.style.display = 'none';
                            commentUploadProgress.textContent = '';
                        }
                    }
                }, 3000);
            }
        }

        // Render a comment
        function renderComment(comment, commentsListElement, postId) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.setAttribute('data-comment-id', comment.id);

            const commentTimestamp = comment.timestamp && typeof comment.timestamp.toDate === 'function'
                                    ? comment.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0])
                                    : (comment.timestamp ? new Date(comment.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

            const noCommentP = commentsListElement.querySelector('p[style*="No comments yet"]');
            if(noCommentP) noCommentP.remove();

            let commentContentHTML = '';
            if (comment.text) commentContentHTML += `<p>${escapeHTML(comment.text).replace(/\n/g, '<br>')}</p>`;
            if (comment.imageUrl) commentContentHTML += `<img src="${comment.imageUrl}" alt="Comment image" class="comment-image" onerror="this.style.display='none';">`;

            commentDiv.innerHTML = `
                <div class="comment-header">
                    <img src="${comment.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(comment.userName || 'User')}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                    <strong>${escapeHTML(comment.userName) || 'User'}</strong>
                    <span class="timestamp">${commentTimestamp}</span>
                </div>
                <div class="comment-content">${commentContentHTML || '<p> </p>'}</div>
                <div class="comment-actions">
                    <button class="reply-to-comment-btn" data-post-id="${postId}" data-comment-id="${comment.id}">
                        <i class="fas fa-reply"></i> <span data-translate-key="replyAction">${_('replyAction')}</span>
                    </button>
                </div>
                <div class="replies-list" id="replies-list-${comment.id}"></div>
                <div class="reply-form-container" id="reply-form-container-${comment.id}" style="display: none;">
                    <form class="reply-form-actual" data-post-id="${postId}" data-parent-comment-id="${comment.id}">
                        <input type="text" name="replyText" class="reply-text-input" placeholder="${_('writeReplyPlaceholder')}" autocomplete="off">
                        <button type="submit" class="reply-submit-btn">${_('replyPostButton')}</button>
                    </form>
                </div>`;
            commentsListElement.appendChild(commentDiv);

            // Load replies
            const repliesListDiv = commentDiv.querySelector(`#replies-list-${comment.id}`);
            if (comment.replies && comment.replies.length > 0) {
                const sortedReplies = [...comment.replies].sort((a,b) => {
                    const timeA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                    const timeB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                    return timeA - timeB;
                });
                sortedReplies.forEach(reply => renderReply(reply, repliesListDiv));
            }

            // Set up event listeners for the comment
            const replyButton = commentDiv.querySelector('.reply-to-comment-btn');
            if (replyButton) replyButton.addEventListener('click', () => toggleReplyForm(comment.id));
            
            const replyForm = commentDiv.querySelector('.reply-form-actual');
            if (replyForm) replyForm.addEventListener('submit', (e) => handleReplySubmit(e, postId, comment.id));
        }

        // Toggle reply form visibility
        function toggleReplyForm(commentId) {
            const replyFormContainer = document.getElementById(`reply-form-container-${commentId}`);
            if (replyFormContainer) {
                const isHidden = replyFormContainer.style.display === 'none' || replyFormContainer.style.display === '';
                replyFormContainer.style.display = isHidden ? 'block' : 'none';
                if (isHidden) {
                    const inputField = replyFormContainer.querySelector('.reply-text-input');
                    if (inputField) inputField.focus();
                }
            }
        }

        // Handle reply submission
        async function handleReplySubmit(event, postId, parentCommentId) {
            event.preventDefault();
            const currentUser = auth.currentUser;
            if (!currentUser) { alert(_('loginRequiredToReply')); return; }

            const form = event.target;
            const replyTextInput = form.querySelector('.reply-text-input');
            const replyText = replyTextInput ? replyTextInput.value.trim() : "";

            if (!replyText) { alert(_('replyTextRequired')); return; }

            const submitButton = form.querySelector('.reply-submit-btn');
            if (submitButton) { submitButton.disabled = true; submitButton.textContent = _('postingButton');}

            const postRef = db.collection('posts').doc(postId);
            try {
                 const newReply = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'User',
                    userPhoto: currentUser.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=',
                    text: replyText,
                    timestamp: new Date()
                };

                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(postRef);
                    if (!doc.exists) throw "Post document does not exist!";
                    const postData = doc.data();
                    const comments = postData.comments || [];
                    const updatedComments = comments.map(comment => {
                        if (comment.id === parentCommentId) {
                            const existingReplies = comment.replies || [];
                            return { ...comment, replies: [...existingReplies, newReply] };
                        }
                        return comment;
                    });
                    transaction.update(postRef, { comments: updatedComments });
                });
                if (replyTextInput) replyTextInput.value = '';
                toggleReplyForm(parentCommentId);
            } catch (error) {
                console.error("Error adding reply:", error);
                alert("Failed to add reply: " + error.message);
            } finally {
                if (submitButton) { submitButton.disabled = false; submitButton.textContent = _('replyPostButton');}
            }
        }

        // Render a reply
        function renderReply(reply, repliesListDiv) {
            const replyDiv = document.createElement('div');
            replyDiv.className = 'comment-reply';

            const replyTimestamp = reply.timestamp && typeof reply.timestamp.toDate === 'function'
                                    ? reply.timestamp.toDate().toLocaleString(currentLanguage.split('-')[0])
                                    : (reply.timestamp ? new Date(reply.timestamp).toLocaleString(currentLanguage.split('-')[0]) : 'Recently');

            let replyContentHTML = '';
            if (reply.text) {
                replyContentHTML = `<p>${escapeHTML(reply.text).replace(/\n/g, '<br>')}</p>`;
            }
            replyDiv.innerHTML = `
                <div class="comment-header">
                    <img src="${reply.userPhoto || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="${escapeHTML(reply.userName || 'User')}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';">
                    <strong>${escapeHTML(reply.userName) || 'User'}</strong>
                    <span class="timestamp">${replyTimestamp}</span>
                </div>
                <div class="comment-content">${replyContentHTML || '<p> </p>'}</div>`;
            repliesListDiv.appendChild(replyDiv);
        }

        // Handle post deletion
        async function handleDeletePost(postId, imageUrl, imagePublicId) {
            const currentUser = auth.currentUser;
            if (!currentUser) { alert(_('loginRequiredToPost')); return; }
            if (!confirm(_('deletePostConfirm'))) return;
            const postRef = db.collection('posts').doc(postId);
            try {
                const doc = await postRef.get();
                if (doc.exists && doc.data().userId === currentUser.uid) {
                    await postRef.delete();
                    if (imageUrl) console.warn(`Image at ${escapeHTML(imageUrl)} (public_id: ${escapeHTML(imagePublicId) || 'N/A'}) needs server-side deletion.`);
                } else { alert("Permission denied or post not found."); }
            } catch (error) {
                console.error("Error deleting post:", error);
                alert("Failed to delete post: " + error.message);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            const s = String(str);
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(s));
            return div.innerHTML;
        }

        // Auth state change handler
        auth.onAuthStateChanged(user => {
            if (user) {
                if(elements.loginSection) elements.loginSection.style.display = 'none';
                if(elements.appSection) elements.appSection.style.display = 'block';
                if(elements.userPhoto) elements.userPhoto.src = user.photoURL || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                if(elements.userName) elements.userName.textContent = user.displayName || 'User';

                if (elements.mobileLoginLink) elements.mobileLoginLink.style.display = 'none';
                if (elements.mobileLogoutLink) elements.mobileLogoutLink.style.display = 'flex';

                loadPosts();
            } else {
                if(elements.loginSection) elements.loginSection.style.display = 'block';
                if(elements.appSection) elements.appSection.style.display = 'none';
                if(elements.postsContainer) {
                     elements.postsContainer.innerHTML = `<h3 data-translate-key="feedTitle">${_('feedTitle')}</h3><p>${_('loginToSeeFeed')}</p>`;
                }

                if (elements.mobileLoginLink) elements.mobileLoginLink.style.display = 'flex';
                if (elements.mobileLogoutLink) elements.mobileLogoutLink.style.display = 'none';

                if (postsUnsubscribe) {
                    postsUnsubscribe();
                    postsUnsubscribe = null;
                }
            }
            applyTranslations();
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            setActiveLanguage(currentLanguage);
        });
    </script>
</body>
</html>
